



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1, mkdocs-material-4.6.3">
    
    
      
        <title>LightInject</title>
      
    
    
      <link rel="stylesheet" href="assets/stylesheets/application.adb8469c.css">
      
      
    
    
      <script src="assets/javascripts/modernizr.86422ebf.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="assets/fonts/material-icons.css">
    
    
    
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#installing" tabindex="0" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="." title="LightInject" aria-label="LightInject" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              LightInject
            </span>
            <span class="md-header-nav__topic">
              
                Home
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" aria-label="search" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/seesharper/lightinject/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="." title="LightInject" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    LightInject
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/seesharper/lightinject/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Home
      </label>
    
    <a href="." title="Home" class="md-nav__link md-nav__link--active">
      Home
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#installing" class="md-nav__link">
    Installing
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#binary" class="md-nav__link">
    Binary
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#source" class="md-nav__link">
    Source
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#creating-a-container" class="md-nav__link">
    Creating a container
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#default-services" class="md-nav__link">
    Default services
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#named-services" class="md-nav__link">
    Named services
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#unresolved-services" class="md-nav__link">
    Unresolved services
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ienumerablet" class="md-nav__link">
    IEnumerable&lt;T&gt;
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ordering" class="md-nav__link">
    Ordering
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#values" class="md-nav__link">
    Values
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#compilation" class="md-nav__link">
    Compilation
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#open-generics" class="md-nav__link">
    Open Generics
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lifetime" class="md-nav__link">
    Lifetime
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#perscopelifetime" class="md-nav__link">
    PerScopeLifetime
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#percontainerlifetime" class="md-nav__link">
    PerContainerLifetime
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#perrequestlifetime" class="md-nav__link">
    PerRequestLifeTime
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#custom-lifetime" class="md-nav__link">
    Custom lifetime
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#important" class="md-nav__link">
    Important
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#async-and-await" class="md-nav__link">
    Async and Await
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#scope" class="md-nav__link">
    Scope
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dependencies" class="md-nav__link">
    Dependencies
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#constructor-injection" class="md-nav__link">
    Constructor Injection
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#implicit-service-registration" class="md-nav__link">
    Implicit service registration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#explicit-service-registration" class="md-nav__link">
    Explicit service registration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#parameters" class="md-nav__link">
    Parameters
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optional-arguments" class="md-nav__link">
    Optional arguments
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#property-injection" class="md-nav__link">
    Property Injection
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#implicit-service-registration_1" class="md-nav__link">
    Implicit service registration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#explicit-service-registration_1" class="md-nav__link">
    Explicit service registration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#property-injection-on-existing-instances" class="md-nav__link">
    Property injection on existing instances.
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#disabling-properyinjection" class="md-nav__link">
    Disabling ProperyInjection
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#initializers" class="md-nav__link">
    Initializers
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#assembly-scanning" class="md-nav__link">
    Assembly Scanning
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#composition-root" class="md-nav__link">
    Composition Root
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#lazy-composition-roots" class="md-nav__link">
    Lazy Composition Roots
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#compositionrootattribute" class="md-nav__link">
    CompositionRootAttribute
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#registerfrom" class="md-nav__link">
    RegisterFrom
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#generics" class="md-nav__link">
    Generics
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#constraints" class="md-nav__link">
    Constraints
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lazyt" class="md-nav__link">
    Lazy&lt;T&gt;
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#function-factories" class="md-nav__link">
    Function Factories
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#named-factories" class="md-nav__link">
    Named Factories
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#parameters_1" class="md-nav__link">
    Parameters
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#idisposable" class="md-nav__link">
    IDisposable
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#typed-factories" class="md-nav__link">
    Typed Factories
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#parameters_2" class="md-nav__link">
    Parameters
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#idisposable_1" class="md-nav__link">
    IDisposable
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#recursive-dependency-detection" class="md-nav__link">
    Recursive dependency detection
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#internals" class="md-nav__link">
    Internals
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#logging" class="md-nav__link">
    Logging
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#unit-testing" class="md-nav__link">
    Unit Testing
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="designpatterns/" title="Patterns" class="md-nav__link">
      Patterns
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Extensions
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Extensions
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="interception/" title="Interception" class="md-nav__link">
      Interception
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="autofactory/" title="AutoFactory" class="md-nav__link">
      AutoFactory
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="annotation/" title="Annotation" class="md-nav__link">
      Annotation
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      Integrations
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Integrations
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="xunit/" title="xUnit" class="md-nav__link">
      xUnit
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="web/" title="Web" class="md-nav__link">
      Web
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="mvc/" title="Mvc" class="md-nav__link">
      Mvc
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="wcf/" title="WCF" class="md-nav__link">
      WCF
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="webapi/" title="Web Api" class="md-nav__link">
      Web Api
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="signalr/" title="SignalR" class="md-nav__link">
      SignalR
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="nancy/" title="Nancy" class="md-nav__link">
      Nancy
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="microsoft.aspnetcore.hosting/" title="AspNetCore" class="md-nav__link">
      AspNetCore
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="microsoft.dependencyinjection/" title="Microsoft DI" class="md-nav__link">
      Microsoft DI
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      Blog
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        Blog
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="webapirequestlogging/" title="Web Api Request Logging" class="md-nav__link">
      Web Api Request Logging
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="transactions/" title="Transactions and Testing" class="md-nav__link">
      Transactions and Testing
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="aspnetcoreunittesting/" title="AspNetCore unit testing" class="md-nav__link">
      AspNetCore unit testing
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="blog-dotnet-steps/" title="Reflection in C# scripts" class="md-nav__link">
      Reflection in C# scripts
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      Side Projects
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        Side Projects
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="lightmock/" title="LightMock" class="md-nav__link">
      LightMock
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7">
    
    <label class="md-nav__link" for="nav-7">
      About
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-7">
        About
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="licence/" title="Licence" class="md-nav__link">
      Licence
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#installing" class="md-nav__link">
    Installing
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#binary" class="md-nav__link">
    Binary
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#source" class="md-nav__link">
    Source
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#creating-a-container" class="md-nav__link">
    Creating a container
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#default-services" class="md-nav__link">
    Default services
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#named-services" class="md-nav__link">
    Named services
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#unresolved-services" class="md-nav__link">
    Unresolved services
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ienumerablet" class="md-nav__link">
    IEnumerable&lt;T&gt;
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ordering" class="md-nav__link">
    Ordering
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#values" class="md-nav__link">
    Values
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#compilation" class="md-nav__link">
    Compilation
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#open-generics" class="md-nav__link">
    Open Generics
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lifetime" class="md-nav__link">
    Lifetime
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#perscopelifetime" class="md-nav__link">
    PerScopeLifetime
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#percontainerlifetime" class="md-nav__link">
    PerContainerLifetime
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#perrequestlifetime" class="md-nav__link">
    PerRequestLifeTime
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#custom-lifetime" class="md-nav__link">
    Custom lifetime
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#important" class="md-nav__link">
    Important
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#async-and-await" class="md-nav__link">
    Async and Await
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#scope" class="md-nav__link">
    Scope
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dependencies" class="md-nav__link">
    Dependencies
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#constructor-injection" class="md-nav__link">
    Constructor Injection
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#implicit-service-registration" class="md-nav__link">
    Implicit service registration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#explicit-service-registration" class="md-nav__link">
    Explicit service registration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#parameters" class="md-nav__link">
    Parameters
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optional-arguments" class="md-nav__link">
    Optional arguments
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#property-injection" class="md-nav__link">
    Property Injection
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#implicit-service-registration_1" class="md-nav__link">
    Implicit service registration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#explicit-service-registration_1" class="md-nav__link">
    Explicit service registration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#property-injection-on-existing-instances" class="md-nav__link">
    Property injection on existing instances.
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#disabling-properyinjection" class="md-nav__link">
    Disabling ProperyInjection
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#initializers" class="md-nav__link">
    Initializers
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#assembly-scanning" class="md-nav__link">
    Assembly Scanning
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#composition-root" class="md-nav__link">
    Composition Root
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#lazy-composition-roots" class="md-nav__link">
    Lazy Composition Roots
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#compositionrootattribute" class="md-nav__link">
    CompositionRootAttribute
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#registerfrom" class="md-nav__link">
    RegisterFrom
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#generics" class="md-nav__link">
    Generics
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#constraints" class="md-nav__link">
    Constraints
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lazyt" class="md-nav__link">
    Lazy&lt;T&gt;
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#function-factories" class="md-nav__link">
    Function Factories
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#named-factories" class="md-nav__link">
    Named Factories
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#parameters_1" class="md-nav__link">
    Parameters
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#idisposable" class="md-nav__link">
    IDisposable
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#typed-factories" class="md-nav__link">
    Typed Factories
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#parameters_2" class="md-nav__link">
    Parameters
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#idisposable_1" class="md-nav__link">
    IDisposable
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#recursive-dependency-detection" class="md-nav__link">
    Recursive dependency detection
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#internals" class="md-nav__link">
    Internals
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#logging" class="md-nav__link">
    Logging
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#unit-testing" class="md-nav__link">
    Unit Testing
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/seesharper/lightinject/edit/master/docs/index.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                  <h1>Home</h1>
                
                <p><a href="https://ci.appveyor.com/project/seesharper/lightinject/branch/master"><img alt="AppVeyor" src="https://img.shields.io/appveyor/ci/seesharper/lightinject.svg?maxAge=2592000" /></a>
<a href="https://www.nuget.org/packages/LightInject"><img alt="NuGet" src="https://img.shields.io/nuget/v/LightInject.svg?maxAge=2592000" /></a>
<a href="https://github.com/seesharper/LightInject/releases/latest"><img alt="GitHub tag" src="https://img.shields.io/github/tag/seesharper/lightinject.svg?maxAge=2592000" /></a></p>
<p><a href="https://www.buymeacoffee.com/Y3bqWk1" target="_blank"><img src="https://bmc-cdn.nyc3.digitaloceanspaces.com/BMC-button-images/custom_images/orange_img.png" alt="Buy Me A Coffee" style="height: auto !important;width: auto !important;" ></a></p>
<h2 id="installing">Installing<a class="headerlink" href="#installing" title="Permanent link">&para;</a></h2>
<p><strong>LightInject</strong> provides two distribution models via NuGet</p>
<h3 id="binary">Binary<a class="headerlink" href="#binary" title="Permanent link">&para;</a></h3>
<div class="nuget-badge" >
   <p>
         <code>PM&gt; Install-Package LightInject</code>
   </p>
</div>

<p>This adds a reference to the LightInject.dll in the target project.</p>
<h3 id="source">Source<a class="headerlink" href="#source" title="Permanent link">&para;</a></h3>
<div class="nuget-badge" >
   <p>
         <code>PM&gt; Install-Package LightInject.Source </code>
   </p>
</div>

<p>This will install a single file (LightInject.cs) into the current project.</p>
<h3 id="creating-a-container">Creating a container<a class="headerlink" href="#creating-a-container" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="kt">var</span> <span class="n">container</span> <span class="p">=</span> <span class="k">new</span> <span class="n">LightInject</span><span class="p">.</span><span class="n">ServiceContainer</span><span class="p">();</span>
</code></pre></div>


<p>The container implements IDisposable and should be disposed after usage has completed. It can also be used inside of a using statement for a constrained scope.</p>
<h3 id="default-services">Default services<a class="headerlink" href="#default-services" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="k">public</span> <span class="k">interface</span> <span class="n">IFoo</span> <span class="p">{}</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">Foo</span> <span class="p">:</span> <span class="n">IFoo</span> <span class="p">{}</span>
</code></pre></div>


<hr />
<div class="codehilite"><pre><span></span><code><span class="n">container</span><span class="p">.</span><span class="n">Register</span><span class="p">&lt;</span><span class="n">IFoo</span><span class="p">,</span> <span class="n">Foo</span><span class="p">&gt;();</span>
<span class="kt">var</span> <span class="n">instance</span> <span class="p">=</span> <span class="n">container</span><span class="p">.</span><span class="n">GetInstance</span><span class="p">&lt;</span><span class="n">IFoo</span><span class="p">&gt;();</span>
<span class="n">Assert</span><span class="p">.</span><span class="n">IsInstanceOfType</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="k">typeof</span><span class="p">(</span><span class="n">Foo</span><span class="p">));</span>
</code></pre></div>


<h3 id="named-services">Named services<a class="headerlink" href="#named-services" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="k">public</span> <span class="k">class</span> <span class="nc">Foo</span> <span class="p">:</span> <span class="n">IFoo</span> <span class="p">{}</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">AnotherFoo</span> <span class="p">:</span> <span class="n">IFoo</span> <span class="p">{}</span>
</code></pre></div>


<hr />
<div class="codehilite"><pre><span></span><code><span class="n">container</span><span class="p">.</span><span class="n">Register</span><span class="p">&lt;</span><span class="n">IFoo</span><span class="p">,</span> <span class="n">Foo</span><span class="p">&gt;();</span>
<span class="n">container</span><span class="p">.</span><span class="n">Register</span><span class="p">&lt;</span><span class="n">IFoo</span><span class="p">,</span> <span class="n">AnotherFoo</span><span class="p">&gt;(</span><span class="s">&quot;AnotherFoo&quot;</span><span class="p">);</span>
<span class="kt">var</span> <span class="n">instance</span> <span class="p">=</span> <span class="n">container</span><span class="p">.</span><span class="n">GetInstance</span><span class="p">&lt;</span><span class="n">IFoo</span><span class="p">&gt;(</span><span class="s">&quot;AnotherFoo&quot;</span><span class="p">);</span>
<span class="n">Assert</span><span class="p">.</span><span class="n">IsInstanceOfType</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="k">typeof</span><span class="p">(</span><span class="n">AnotherFoo</span><span class="p">));</span>
</code></pre></div>


<p>If only one named registration exists, <strong>LightInject</strong> is capable of resolving this as the default service.</p>
<div class="codehilite"><pre><span></span><code><span class="n">container</span><span class="p">.</span><span class="n">Register</span><span class="p">&lt;</span><span class="n">IFoo</span><span class="p">,</span> <span class="n">AnotherFoo</span><span class="p">&gt;(</span><span class="s">&quot;AnotherFoo&quot;</span><span class="p">);</span>
<span class="kt">var</span> <span class="n">instance</span> <span class="p">=</span> <span class="n">container</span><span class="p">.</span><span class="n">GetInstance</span><span class="p">&lt;</span><span class="n">IFoo</span><span class="p">&gt;();</span>
<span class="n">Assert</span><span class="p">.</span><span class="n">IsInstanceOfType</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="k">typeof</span><span class="p">(</span><span class="n">AnotherFoo</span><span class="p">));</span>
</code></pre></div>


<h3 id="unresolved-services">Unresolved services<a class="headerlink" href="#unresolved-services" title="Permanent link">&para;</a></h3>
<p>LightInject can resolve services that are not registered with the container using the <em>RegisterFallback</em> method.</p>
<div class="codehilite"><pre><span></span><code><span class="kt">var</span> <span class="n">container</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ServiceContainer</span><span class="p">();</span>
<span class="n">container</span><span class="p">.</span><span class="n">RegisterFallback</span><span class="p">((</span><span class="n">type</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="k">true</span><span class="p">,</span> <span class="n">request</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="n">Foo</span><span class="p">());</span>
<span class="kt">var</span> <span class="n">foo</span> <span class="p">=</span> <span class="n">container</span><span class="p">.</span><span class="n">GetInstance</span><span class="p">&lt;</span><span class="n">IFoo</span><span class="p">&gt;();</span>
</code></pre></div>


<p>The first argument to the <em>RegisterFallback</em> method makes it possible to possible to decide if the service can be "late-resolved".
The second argument is a <em>ServiceRequest</em> instance that provides the requested service type and service name.</p>
<h3 id="ienumerablet">IEnumerable&lt;T&gt;<a class="headerlink" href="#ienumerablet" title="Permanent link">&para;</a></h3>
<p>When we register multiple services with the same service type, <strong>LightInject</strong> is capable of resolving these services as an  <a href="http://msdn.microsoft.com/en-us/library/9eekhta0.aspx">IEnumerable&lt;T&gt;</a>.</p>
<div class="codehilite"><pre><span></span><code><span class="k">public</span> <span class="k">class</span> <span class="nc">Foo</span> <span class="p">:</span> <span class="n">IFoo</span> <span class="p">{}</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">AnotherFoo</span> <span class="p">:</span> <span class="n">IFoo</span> <span class="p">{}</span>
</code></pre></div>


<hr />
<div class="codehilite"><pre><span></span><code><span class="n">container</span><span class="p">.</span><span class="n">Register</span><span class="p">&lt;</span><span class="n">IFoo</span><span class="p">,</span> <span class="n">Foo</span><span class="p">&gt;();</span>
<span class="n">container</span><span class="p">.</span><span class="n">Register</span><span class="p">&lt;</span><span class="n">IFoo</span><span class="p">,</span> <span class="n">AnotherFoo</span><span class="p">&gt;(</span><span class="s">&quot;AnotherFoo&quot;</span><span class="p">);</span>
<span class="kt">var</span> <span class="n">instances</span> <span class="p">=</span> <span class="n">container</span><span class="p">.</span><span class="n">GetInstance</span><span class="p">&lt;</span><span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">IFoo</span><span class="p">&gt;&gt;();</span>
<span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="m">2</span><span class="p">,</span> <span class="n">instances</span><span class="p">.</span><span class="n">Count</span><span class="p">());</span>
</code></pre></div>


<p>Alternatively using the <strong>GetAllInstances</strong> method.</p>
<div class="codehilite"><pre><span></span><code><span class="kt">var</span> <span class="n">instances</span> <span class="p">=</span> <span class="n">container</span><span class="p">.</span><span class="n">GetAllInstances</span><span class="p">&lt;</span><span class="n">IFoo</span><span class="p">&gt;();</span>
<span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="m">2</span><span class="p">,</span> <span class="n">instances</span><span class="p">.</span><span class="n">Count</span><span class="p">());</span>
</code></pre></div>


<p>In addition, <strong>LightInject</strong> supports the following <a href="http://msdn.microsoft.com/en-us/library/9eekhta0.aspx">IEnumerable&lt;T&gt;</a> sub-types. </p>
<ul>
<li>Array</li>
<li>ICollection&lt;T&gt;</li>
<li>IList&lt;T&gt;</li>
<li>IReadOnlyCollection&lt;T&gt; (Net 4.5 and Windows Runtime);</li>
<li>IReadOnlyList&lt;T&gt; (Net 4.5 and Windows Runtime)</li>
</ul>
<p>By default, <strong>LightInject</strong> will resolve all services that are compatible with the requested element type.</p>
<div class="codehilite"><pre><span></span><code><span class="n">container</span><span class="p">.</span><span class="n">Register</span><span class="p">&lt;</span><span class="n">Foo</span><span class="p">&gt;();</span>
<span class="n">container</span><span class="p">.</span><span class="n">Register</span><span class="p">&lt;</span><span class="n">DerivedFoo</span><span class="p">&gt;();</span>
<span class="kt">var</span> <span class="n">instances</span> <span class="p">=</span> <span class="n">container</span><span class="p">.</span><span class="n">GetAllInstances</span><span class="p">&lt;</span><span class="n">Foo</span><span class="p">&gt;();</span>
<span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="m">2</span><span class="p">,</span> <span class="n">instances</span><span class="p">.</span><span class="n">Count</span><span class="p">());</span>
</code></pre></div>


<p>This behavior can be overridden using the <strong>EnableVariance</strong> container option.</p>
<div class="codehilite"><pre><span></span><code><span class="kt">var</span> <span class="n">container</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ServiceContainer</span><span class="p">(</span><span class="k">new</span> <span class="n">ContainerOptions</span> <span class="p">{</span> <span class="n">EnableVariance</span> <span class="p">=</span> <span class="k">false</span> <span class="p">});</span>
<span class="n">container</span><span class="p">.</span><span class="n">Register</span><span class="p">&lt;</span><span class="n">Foo</span><span class="p">&gt;();</span>
<span class="n">container</span><span class="p">.</span><span class="n">Register</span><span class="p">&lt;</span><span class="n">DerivedFoo</span><span class="p">&gt;();</span>
<span class="kt">var</span> <span class="n">instances</span> <span class="p">=</span> <span class="n">container</span><span class="p">.</span><span class="n">GetAllInstances</span><span class="p">&lt;</span><span class="n">Foo</span><span class="p">&gt;();</span>
<span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="n">instances</span><span class="p">.</span><span class="n">Count</span><span class="p">());</span>
</code></pre></div>


<p>We can also selectively decide to apply variance only for certain <code>IEnumerable&lt;T&gt;</code> services.</p>
<div class="codehilite"><pre><span></span><code><span class="n">options</span><span class="p">.</span><span class="n">VarianceFilter</span> <span class="p">=</span> <span class="p">(</span><span class="n">enumerableType</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">enumerableType</span><span class="p">.</span><span class="n">GetGenericArguments</span><span class="p">()[</span><span class="m">0</span><span class="p">]</span> <span class="p">==</span> <span class="k">typeof</span><span class="p">(</span><span class="n">IFoo</span><span class="p">);</span>
</code></pre></div>


<h4 id="ordering">Ordering<a class="headerlink" href="#ordering" title="Permanent link">&para;</a></h4>
<p>Sometimes the ordering of the resolved services are important and <strong>LightInject</strong> solves this by ordering services by their service name.</p>
<div class="codehilite"><pre><span></span><code><span class="n">container</span><span class="p">.</span><span class="n">Register</span><span class="p">&lt;</span><span class="n">IFoo</span><span class="p">,</span> <span class="n">Foo1</span><span class="p">&gt;(</span><span class="s">&quot;A&quot;</span><span class="p">);</span>
<span class="n">container</span><span class="p">.</span><span class="n">Register</span><span class="p">&lt;</span><span class="n">IFoo</span><span class="p">,</span> <span class="n">Foo2</span><span class="p">&gt;(</span><span class="s">&quot;B&quot;</span><span class="p">);</span>
<span class="n">container</span><span class="p">.</span><span class="n">Register</span><span class="p">&lt;</span><span class="n">IFoo</span><span class="p">,</span> <span class="n">Foo3</span><span class="p">&gt;(</span><span class="s">&quot;C&quot;</span><span class="p">);</span>

<span class="kt">var</span> <span class="n">instances</span> <span class="p">=</span> <span class="n">container</span><span class="p">.</span><span class="n">GetAllInstances</span><span class="p">&lt;</span><span class="n">IFoo</span><span class="p">&gt;().</span><span class="n">ToArray</span><span class="p">();</span>
<span class="n">Assert</span><span class="p">.</span><span class="n">IsType</span><span class="p">&lt;</span><span class="n">Foo1</span><span class="p">&gt;(</span><span class="n">instances</span><span class="p">[</span><span class="m">0</span><span class="p">]);</span>
<span class="n">Assert</span><span class="p">.</span><span class="n">IsType</span><span class="p">&lt;</span><span class="n">Foo2</span><span class="p">&gt;(</span><span class="n">instances</span><span class="p">[</span><span class="m">1</span><span class="p">]);</span>
<span class="n">Assert</span><span class="p">.</span><span class="n">IsType</span><span class="p">&lt;</span><span class="n">Foo3</span><span class="p">&gt;(</span><span class="n">instances</span><span class="p">[</span><span class="m">2</span><span class="p">]);</span>
</code></pre></div>


<p>We can also register multiple implementations for a given service type using the <code>RegisterOrdered</code> method.</p>
<div class="codehilite"><pre><span></span><code><span class="kt">var</span> <span class="n">container</span> <span class="p">=</span> <span class="n">CreateContainer</span><span class="p">();</span>
<span class="n">container</span><span class="p">.</span><span class="n">RegisterOrdered</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">IFoo</span><span class="p">),</span> <span class="k">new</span><span class="p">[]</span> <span class="p">{</span><span class="k">typeof</span><span class="p">(</span><span class="n">Foo1</span><span class="p">),</span> <span class="k">typeof</span><span class="p">(</span><span class="n">Foo2</span><span class="p">),</span> <span class="k">typeof</span><span class="p">(</span><span class="n">Foo3</span><span class="p">)},</span>
    <span class="n">type</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="n">PerContainerLifetime</span><span class="p">());</span>

<span class="kt">var</span> <span class="n">instances</span> <span class="p">=</span> <span class="n">container</span><span class="p">.</span><span class="n">GetAllInstances</span><span class="p">&lt;</span><span class="n">IFoo</span><span class="p">&gt;().</span><span class="n">ToArray</span><span class="p">();</span>

<span class="n">Assert</span><span class="p">.</span><span class="n">IsType</span><span class="p">&lt;</span><span class="n">Foo1</span><span class="p">&gt;(</span><span class="n">instances</span><span class="p">[</span><span class="m">0</span><span class="p">]);</span>
<span class="n">Assert</span><span class="p">.</span><span class="n">IsType</span><span class="p">&lt;</span><span class="n">Foo2</span><span class="p">&gt;(</span><span class="n">instances</span><span class="p">[</span><span class="m">1</span><span class="p">]);</span>
<span class="n">Assert</span><span class="p">.</span><span class="n">IsType</span><span class="p">&lt;</span><span class="n">Foo3</span><span class="p">&gt;(</span><span class="n">instances</span><span class="p">[</span><span class="m">2</span><span class="p">]);</span>
</code></pre></div>


<p>The <code>RegisterOrdered</code> method gives each implementation a service name that can be used for ordering when resolving these services. By default the service name is formatted like <code>001</code>, <code>002</code> and so on. 
If we need so change this convention, we can do this by passing a format function to the <code>RegisterOrdered</code> method.</p>
<div class="codehilite"><pre><span></span><code><span class="n">container</span><span class="p">.</span><span class="n">RegisterOrdered</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">IFoo</span><span class="p">&lt;&gt;),</span> <span class="k">new</span><span class="p">[]</span> <span class="p">{</span> <span class="k">typeof</span><span class="p">(</span><span class="n">Foo1</span><span class="p">&lt;&gt;),</span> <span class="k">typeof</span><span class="p">(</span><span class="n">Foo2</span><span class="p">&lt;&gt;),</span> <span class="k">typeof</span><span class="p">(</span><span class="n">Foo3</span><span class="p">&lt;&gt;)</span> <span class="p">},</span>
    <span class="n">type</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="n">PerContainerLifetime</span><span class="p">(),</span> <span class="n">i</span> <span class="p">=&gt;</span> <span class="err">$</span><span class="s">&quot;A{i.ToString().PadLeft(3,&#39;0&#39;)}&quot;</span><span class="p">);</span>

<span class="kt">var</span> <span class="n">services</span> <span class="p">=</span> <span class="n">container</span><span class="p">.</span><span class="n">AvailableServices</span><span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">sr</span> <span class="p">=&gt;</span> <span class="n">sr</span><span class="p">.</span><span class="n">ServiceType</span> <span class="p">==</span> <span class="k">typeof</span><span class="p">(</span><span class="n">IFoo</span><span class="p">&lt;&gt;))</span>
    <span class="p">.</span><span class="n">OrderBy</span><span class="p">(</span><span class="n">sr</span> <span class="p">=&gt;</span> <span class="n">sr</span><span class="p">.</span><span class="n">ServiceName</span><span class="p">).</span><span class="n">ToArray</span><span class="p">();</span>
<span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="s">&quot;A001&quot;</span><span class="p">,</span> <span class="n">services</span><span class="p">[</span><span class="m">0</span><span class="p">].</span><span class="n">ServiceName</span><span class="p">);</span>
<span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="s">&quot;A002&quot;</span><span class="p">,</span> <span class="n">services</span><span class="p">[</span><span class="m">1</span><span class="p">].</span><span class="n">ServiceName</span><span class="p">);</span>
<span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="s">&quot;A003&quot;</span><span class="p">,</span> <span class="n">services</span><span class="p">[</span><span class="m">2</span><span class="p">].</span><span class="n">ServiceName</span><span class="p">);</span>
</code></pre></div>


<h3 id="values">Values<a class="headerlink" href="#values" title="Permanent link">&para;</a></h3>
<p>Registers the value as a constant.</p>
<div class="codehilite"><pre><span></span><code><span class="n">container</span><span class="p">.</span><span class="n">RegisterInstance</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;(</span><span class="s">&quot;SomeValue&quot;</span><span class="p">);</span>
<span class="kt">var</span> <span class="k">value</span> <span class="p">=</span> <span class="n">container</span><span class="p">.</span><span class="n">GetInstance</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;();</span>
<span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="s">&quot;SomeValue, value);</span>
</code></pre></div>


<h3 id="compilation">Compilation<a class="headerlink" href="#compilation" title="Permanent link">&para;</a></h3>
<p><strong>LightInject</strong> uses dynamic code compilation either in the form of System.Reflection.Emit or compiled expression trees. When a service is requested from the container, the code needed for creating the service instance is generated and compiled and a delegate for that code is stored for lookup later on so that we only compile it once. These delegates are stored in an AVL tree that ensures maximal performance when looking up a delegate for a given service type. If fact, looking up these delegates is what sets the top performing containers apart. Most high performance container emits approximately the same code, but the approach to storing these delegates may differ. </p>
<p><strong>LightInject</strong> provides lock-free service lookup meaning that no locks are involved for getting a service instance after its initial generation and compilation. The only time <strong>LightInject</strong> actually creates a lock is when generating the code for a given service.  That does however mean a potential lock contention problem when many concurrent requests asks for services for the first time.</p>
<p><strong>LightInject</strong> deals with this potential problem by providing an API for compilation typically used when an application starts.</p>
<p>The following example shows how to compile all registered services.</p>
<div class="codehilite"><pre><span></span><code><span class="n">container</span><span class="p">.</span><span class="n">Compile</span><span class="p">();</span>
</code></pre></div>


<p>One thing to be aware of is that not all services are backed by its own delegate. </p>
<p>Consider the following service:</p>
<div class="codehilite"><pre><span></span><code><span class="k">public</span> <span class="k">class</span> <span class="nc">Foo</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nf">Foo</span><span class="p">(</span><span class="n">Bar</span> <span class="n">bar</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Bar</span> <span class="p">=</span> <span class="n">bar</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span> 
</code></pre></div>


<p>Registered and resolved like this:</p>
<div class="codehilite"><pre><span></span><code><span class="n">container</span><span class="p">.</span><span class="n">Register</span><span class="p">&lt;</span><span class="n">Foo</span><span class="p">&gt;();</span>
<span class="n">container</span><span class="p">.</span><span class="n">Register</span><span class="p">&lt;</span><span class="n">Bar</span><span class="p">&gt;();</span>
<span class="kt">var</span> <span class="n">foo</span> <span class="p">=</span> <span class="n">container</span><span class="p">.</span><span class="n">GetInstance</span><span class="p">&lt;</span><span class="n">Foo</span><span class="p">&gt;();</span>
</code></pre></div>


<p>In this case we only create a delegate for resolving <code>Foo</code> since that is the only service that is directly requested from the container. The code for creating the <code>Bar</code> instance is embedded inside the code for creating the <code>Foo</code> instance and hence there is only one delegate created.</p>
<p>We call <code>Foo</code> a root service since it is directly requested from the container. </p>
<p>In fact lets just have a look at the IL generated for creating the <code>Foo</code> instance. </p>
<div class="codehilite"><pre><span></span><code>newobj Void .ctor() // Bar
newobj Void .ctor(LightInject.SampleLibrary.IBar) //Foo
</code></pre></div>


<p>What happens here is that a new instance of <code>Bar</code> is created and pushed onto the stack and then we create the <code>Foo</code> instance. This is the code that the delegate for <code>Foo</code> points to. </p>
<p>The reason for such a relatively detailed explanation is to illustrate that we don't always create a delegate for a given service and by simply doing a <code>container.Compile()</code> we might create a lot of delegates that is never actually executed.  Probably no big deal as long as we don't have tens of thousands of services, but just something to be aware of.</p>
<p><strong>LightInject</strong> does not attempt to identify root services as that would be very difficult for various reasons.</p>
<p>We can instead use a predicate when compiling services up front.</p>
<div class="codehilite"><pre><span></span><code><span class="n">container</span><span class="p">.</span><span class="n">Compile</span><span class="p">(</span><span class="n">sr</span> <span class="p">=&gt;</span> <span class="n">sr</span><span class="p">.</span><span class="n">ServiceType</span> <span class="p">==</span> <span class="k">typeof</span><span class="p">(</span><span class="n">Foo</span><span class="p">));</span>
</code></pre></div>


<h4 id="open-generics">Open Generics<a class="headerlink" href="#open-generics" title="Permanent link">&para;</a></h4>
<p><strong>LightInject</strong> cannot compile open generic services since the actual generic arguments are not known at "compile" time. </p>
<p>We can however specify the generic arguments like this:</p>
<div class="codehilite"><pre><span></span><code><span class="n">container</span><span class="p">.</span><span class="n">Compile</span><span class="p">&lt;</span><span class="n">Foo</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;&gt;()</span>
</code></pre></div>


<p><strong>LightInject</strong> will create a log entry every time a new delegate is created so that information can be used to identify root services that could be compiled up front. In addition to this, a log entry (warning) is also created when trying to compile an open generic service up front.</p>
<h2 id="lifetime">Lifetime<a class="headerlink" href="#lifetime" title="Permanent link">&para;</a></h2>
<p>The default behavior in <strong>LightInject</strong> is to treat all objects as transients unless otherwise specified.</p>
<div class="codehilite"><pre><span></span><code><span class="n">container</span><span class="p">.</span><span class="n">Register</span><span class="p">&lt;</span><span class="n">IFoo</span><span class="p">,</span><span class="n">Foo</span><span class="p">&gt;();</span>
<span class="kt">var</span> <span class="n">firstInstance</span> <span class="p">=</span> <span class="n">container</span><span class="p">.</span><span class="n">GetInstance</span><span class="p">&lt;</span><span class="n">IFoo</span><span class="p">&gt;();</span>
<span class="kt">var</span> <span class="n">secondInstance</span> <span class="p">=</span> <span class="n">container</span><span class="p">.</span><span class="n">GetInstance</span><span class="p">&lt;</span><span class="n">IFoo</span><span class="p">&gt;();</span>
<span class="n">Assert</span><span class="p">.</span><span class="n">AreNotSame</span><span class="p">(</span><span class="n">firstInstance</span><span class="p">,</span> <span class="n">secondInstance</span><span class="p">);</span>
</code></pre></div>


<h3 id="perscopelifetime">PerScopeLifetime<a class="headerlink" href="#perscopelifetime" title="Permanent link">&para;</a></h3>
<p>Ensures that only one instance of a given service can exists within a scope.
The container will call the <strong>Dispose</strong> method on all disposable objects created within the scope.</p>
<div class="codehilite"><pre><span></span><code><span class="n">container</span><span class="p">.</span><span class="n">Register</span><span class="p">&lt;</span><span class="n">IFoo</span><span class="p">,</span><span class="n">Foo</span><span class="p">&gt;(</span><span class="k">new</span> <span class="n">PerScopeLifetime</span><span class="p">());</span>
<span class="n">using</span><span class="p">(</span><span class="n">container</span><span class="p">.</span><span class="n">BeginScope</span><span class="p">())</span>
<span class="p">{</span>   
    <span class="kt">var</span> <span class="n">firstInstance</span> <span class="p">=</span> <span class="n">container</span><span class="p">.</span><span class="n">GetInstance</span><span class="p">&lt;</span><span class="n">IFoo</span><span class="p">&gt;();</span>
    <span class="kt">var</span> <span class="n">secondInstance</span> <span class="p">=</span> <span class="n">container</span><span class="p">.</span><span class="n">GetInstance</span><span class="p">&lt;</span><span class="n">IFoo</span><span class="p">&gt;();</span>
    <span class="n">Assert</span><span class="p">.</span><span class="n">AreSame</span><span class="p">(</span><span class="n">firstInstance</span><span class="p">,</span> <span class="n">secondInstance</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>


<p><strong>Note:</strong> <em>An </em><em>InvalidOperationException</em><em> is thrown if a service registered with the </em><em>PerScopeLifetime</em><em> is requested outside the scope.</em></p>
<h3 id="percontainerlifetime">PerContainerLifetime<a class="headerlink" href="#percontainerlifetime" title="Permanent link">&para;</a></h3>
<p>Ensures that only one instance of a given service can exist within the container.
The container will call the Dispose method on all disposable objects when the container itself is disposed.</p>
<div class="codehilite"><pre><span></span><code><span class="n">using</span><span class="p">(</span><span class="n">container</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ServiceContainer</span><span class="p">())</span>
<span class="p">{</span>
    <span class="n">container</span><span class="p">.</span><span class="n">Register</span><span class="p">&lt;</span><span class="n">IFoo</span><span class="p">,</span><span class="n">Foo</span><span class="p">&gt;(</span><span class="k">new</span> <span class="n">PerContainerLifetime</span><span class="p">());</span>   
    <span class="kt">var</span> <span class="n">firstInstance</span> <span class="p">=</span> <span class="n">container</span><span class="p">.</span><span class="n">GetInstance</span><span class="p">&lt;</span><span class="n">IFoo</span><span class="p">&gt;();</span>
    <span class="kt">var</span> <span class="n">secondInstance</span> <span class="p">=</span> <span class="n">container</span><span class="p">.</span><span class="n">GetInstance</span><span class="p">&lt;</span><span class="n">IFoo</span><span class="p">&gt;();</span>
    <span class="n">Assert</span><span class="p">.</span><span class="n">AreSame</span><span class="p">(</span><span class="n">firstInstance</span><span class="p">,</span> <span class="n">secondInstance</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>


<h3 id="perrequestlifetime">PerRequestLifeTime<a class="headerlink" href="#perrequestlifetime" title="Permanent link">&para;</a></h3>
<p>A new instance is created for each request and the container calls <strong>Dispose</strong> when the scope ends.
This lifetime is used when the conrete class implements <strong>IDisposable</strong>.</p>
<div class="codehilite"><pre><span></span><code><span class="n">container</span><span class="p">.</span><span class="n">Register</span><span class="p">&lt;</span><span class="n">IFoo</span><span class="p">,</span><span class="n">Foo</span><span class="p">&gt;(</span><span class="k">new</span> <span class="n">PerRequestLifeTime</span><span class="p">());</span>
<span class="n">using</span><span class="p">(</span><span class="n">container</span><span class="p">.</span><span class="n">BeginScope</span><span class="p">())</span>
<span class="p">{</span>       
    <span class="kt">var</span> <span class="n">firstInstance</span> <span class="p">=</span> <span class="n">container</span><span class="p">.</span><span class="n">GetInstance</span><span class="p">&lt;</span><span class="n">IFoo</span><span class="p">&gt;();</span>
    <span class="kt">var</span> <span class="n">secondInstance</span> <span class="p">=</span> <span class="n">container</span><span class="p">.</span><span class="n">GetInstance</span><span class="p">&lt;</span><span class="n">IFoo</span><span class="p">&gt;();</span>
    <span class="n">Assert</span><span class="p">.</span><span class="n">AreNotSame</span><span class="p">(</span><span class="n">firstInstance</span><span class="p">,</span> <span class="n">secondInstance</span><span class="p">);</span>
<span class="p">}</span>   
</code></pre></div>


<blockquote>
<p><strong>Note:</strong> <em>An </em><em>InvalidOperationException</em><em> is thrown if a service registered with the </em><em>PerRequestLifeTime</em><em> is requested outside the scope.</em></p>
</blockquote>
<h3 id="custom-lifetime">Custom lifetime<a class="headerlink" href="#custom-lifetime" title="Permanent link">&para;</a></h3>
<p>A custom lifetime is created by implementing the <strong>ILifetime</strong> interface</p>
<div class="codehilite"><pre><span></span><code><span class="k">internal</span> <span class="k">interface</span> <span class="n">ILifetime</span>
<span class="p">{</span>
    <span class="kt">object</span> <span class="nf">GetInstance</span><span class="p">(</span><span class="n">Func</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">&gt;</span> <span class="n">instanceFactory</span><span class="p">,</span> <span class="n">Scope</span> <span class="n">currentScope</span><span class="p">);</span>        
<span class="p">}</span>
</code></pre></div>


<p>The following example shows to create a custom lifetime that ensures only one instance per thread.</p>
<div class="codehilite"><pre><span></span><code><span class="k">public</span> <span class="k">class</span> <span class="nc">PerThreadLifetime</span> <span class="p">:</span> <span class="n">ILifetime</span>
<span class="p">{</span>
    <span class="n">ThreadLocal</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">&gt;</span> <span class="n">instances</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ThreadLocal</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">&gt;();</span>  

    <span class="k">public</span> <span class="kt">object</span> <span class="nf">GetInstance</span><span class="p">(</span><span class="n">Func</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">&gt;</span> <span class="n">instanceFactory</span><span class="p">,</span> <span class="n">Scope</span> <span class="n">currentScope</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">instances</span><span class="p">.</span><span class="k">value</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">instances</span><span class="p">.</span><span class="k">value</span> <span class="p">=</span> <span class="n">instanceFactory</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">instances</span><span class="p">.</span><span class="k">value</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>


<p>That is all it takes to create a custom lifetime, but what about disposable services?</p>
<div class="codehilite"><pre><span></span><code><span class="k">public</span> <span class="k">class</span> <span class="nc">PerThreadLifetime</span> <span class="p">:</span> <span class="n">ILifetime</span>
<span class="p">{</span>
    <span class="n">ThreadLocal</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">&gt;</span> <span class="n">instances</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ThreadLocal</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">&gt;();</span>  

    <span class="k">public</span> <span class="kt">object</span> <span class="nf">GetInstance</span><span class="p">(</span><span class="n">Func</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">&gt;</span> <span class="n">instanceFactory</span><span class="p">,</span> <span class="n">Scope</span> <span class="n">currentScope</span><span class="p">)</span>
    <span class="p">{</span>           
        <span class="k">if</span> <span class="p">(</span><span class="n">instances</span><span class="p">.</span><span class="k">value</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
        <span class="p">{</span>               
            <span class="kt">object</span> <span class="n">instance</span> <span class="p">=</span> <span class="n">instanceFactory</span><span class="p">();</span>                
            <span class="n">IDisposable</span> <span class="n">disposable</span> <span class="p">=</span> <span class="n">instance</span> <span class="k">as</span> <span class="n">IDisposable</span><span class="p">;</span>               
            <span class="k">if</span> <span class="p">(</span><span class="n">disposable</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">currentScope</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nf">InvalidOperationException</span><span class="p">(</span><span class="s">&quot;Attempt to create an disposable object </span>
                                                        <span class="n">without</span> <span class="n">a</span> <span class="n">current</span> <span class="n">scope</span><span class="p">.</span><span class="s">&quot;)</span>
                <span class="p">}</span>
                <span class="n">currentScope</span><span class="p">.</span><span class="n">TrackInstance</span><span class="p">(</span><span class="n">disposable</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="n">instances</span><span class="p">.</span><span class="k">value</span> <span class="p">=</span> <span class="n">instance</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">instance</span><span class="p">.</span><span class="k">value</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>


<h4 id="important">Important<a class="headerlink" href="#important" title="Permanent link">&para;</a></h4>
<p>A lifetime object controls the lifetime of a single service and can <strong>never</strong> be shared for multiple service registrations.</p>
<p><strong>Wrong</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">ILifetime</span> <span class="n">lifetime</span> <span class="p">=</span> <span class="k">new</span> <span class="n">PerContainerLifeTime</span><span class="p">();</span>
<span class="n">container</span><span class="p">.</span><span class="n">Register</span><span class="p">&lt;</span><span class="n">IFoo</span><span class="p">,</span><span class="n">Foo</span><span class="p">&gt;(</span><span class="n">lifetime</span><span class="p">);</span>
<span class="n">container</span><span class="p">.</span><span class="n">Register</span><span class="p">&lt;</span><span class="n">IBar</span><span class="p">,</span><span class="n">Bar</span><span class="p">&gt;(</span><span class="n">lifetime</span><span class="p">);</span>
</code></pre></div>


<p><strong>Right</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">container</span><span class="p">.</span><span class="n">Register</span><span class="p">&lt;</span><span class="n">IFoo</span><span class="p">,</span><span class="n">Foo</span><span class="p">&gt;(</span><span class="k">new</span> <span class="n">PerContainerLifeTime</span><span class="p">());</span>
<span class="n">container</span><span class="p">.</span><span class="n">Register</span><span class="p">&lt;</span><span class="n">IBar</span><span class="p">,</span><span class="n">Bar</span><span class="p">&gt;(</span><span class="k">new</span> <span class="n">PerContainerLifeTime</span><span class="p">());</span>
</code></pre></div>


<p>A lifetime object is also shared across threads and that is something we must take into consideration when developing new lifetime implementations.</p>
<h3 id="async-and-await">Async and Await<a class="headerlink" href="#async-and-await" title="Permanent link">&para;</a></h3>
<p>By default scopes are managed per thread which means that when the container looks for the current scope, it will look for a scope that is associated with the current thread.</p>
<p>With the introduction of the async/await pattern chances are that the code that is requesting a service instance is running on another thread.</p>
<p>To illustrate this lets consider an example that is going to cause an instance to be resolved on another thread.</p>
<p>We start of by creating an interface that returns a <strong>Task&lt;IBar&gt;</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">public</span> <span class="k">interface</span> <span class="n">IAsyncFoo</span>
<span class="p">{</span>
    <span class="n">Task</span><span class="p">&lt;</span><span class="n">IBar</span><span class="p">&gt;</span> <span class="n">GetBar</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>


<p>Next we implement this interface in such a way that the <strong>IBar</strong> instance is requested on another thread.</p>
<div class="codehilite"><pre><span></span><code><span class="k">public</span> <span class="k">class</span> <span class="nc">AsyncFoo</span> <span class="p">:</span> <span class="n">IAsyncFoo</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">Lazy</span><span class="p">&lt;</span><span class="n">IBar</span><span class="p">&gt;</span> <span class="n">lazyBar</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">AsyncFoo</span><span class="p">(</span><span class="n">Lazy</span><span class="p">&lt;</span><span class="n">IBar</span><span class="p">&gt;</span> <span class="n">lazyBar</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">lazyBar</span> <span class="p">=</span> <span class="n">lazyBar</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">IBar</span><span class="p">&gt;</span> <span class="n">GetBar</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">await</span> <span class="n">Task</span><span class="p">.</span><span class="n">Delay</span><span class="p">(</span><span class="m">10</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">lazyBar</span><span class="p">.</span><span class="n">Value</span><span class="p">;</span> <span class="p">&lt;--</span><span class="n">This</span> <span class="n">code</span> <span class="k">is</span> <span class="n">executed</span> <span class="k">on</span> <span class="n">another</span> <span class="n">thread</span> <span class="p">(</span><span class="n">continuation</span><span class="p">).</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>


<p>The we register the dependency (<strong>IBar</strong>) with the <strong>PerScopeLifetime</strong> that is going to cause the container to ask for the current scope so that the instance can be registered with that scope.</p>
<div class="codehilite"><pre><span></span><code><span class="kt">var</span> <span class="n">container</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ServiceContainer</span><span class="p">();</span>
<span class="n">container</span><span class="p">.</span><span class="n">Register</span><span class="p">&lt;</span><span class="n">IBar</span><span class="p">,</span> <span class="n">Bar</span><span class="p">&gt;(</span><span class="k">new</span> <span class="n">PerScopeLifetime</span><span class="p">());</span>
<span class="n">container</span><span class="p">.</span><span class="n">Register</span><span class="p">&lt;</span><span class="n">IAsyncFoo</span><span class="p">,</span> <span class="n">AsyncFoo</span><span class="p">&gt;();</span>

<span class="k">using</span> <span class="p">(</span><span class="n">container</span><span class="p">.</span><span class="n">BeginScope</span><span class="p">())</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">instance</span> <span class="p">=</span> <span class="n">container</span><span class="p">.</span><span class="n">GetInstance</span><span class="p">&lt;</span><span class="n">IAsyncFoo</span><span class="p">&gt;();</span>
    <span class="n">ExceptionAssert</span><span class="p">.</span><span class="n">Throws</span><span class="p">&lt;</span><span class="n">AggregateException</span><span class="p">&gt;(()</span> <span class="p">=&gt;</span> <span class="n">instance</span><span class="p">.</span><span class="n">GetBar</span><span class="p">().</span><span class="n">Wait</span><span class="p">());</span>                
<span class="p">}</span>
</code></pre></div>


<p>This will throw an exception that states the following:</p>
<div class="codehilite"><pre><span></span><code>Attempt to create a scoped instance without a current scope.
</code></pre></div>


<p>The reason that this is happening is that the current scope is associated with the thread that created it and when the continuation executes, we are essentially requesting an instance on another thread.</p>
<p>To deal with this issue, <strong>LightInject</strong> now supports scopes across the logical <a href="http://msdn.microsoft.com/en-us/library/system.runtime.remoting.messaging.callcontext(v=vs.110).aspx">CallContext</a>.  </p>
<div class="codehilite"><pre><span></span><code><span class="kt">var</span> <span class="n">container</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ServiceContainer</span><span class="p">();</span>
<span class="n">container</span><span class="p">.</span><span class="n">ScopeManagerProvider</span> <span class="p">=</span> <span class="k">new</span> <span class="n">PerLogicalCallContextScopeManagerProvider</span><span class="p">();</span>
<span class="n">container</span><span class="p">.</span><span class="n">Register</span><span class="p">&lt;</span><span class="n">IBar</span><span class="p">,</span> <span class="n">Bar</span><span class="p">&gt;(</span><span class="k">new</span> <span class="n">PerScopeLifetime</span><span class="p">());</span>
<span class="n">container</span><span class="p">.</span><span class="n">Register</span><span class="p">&lt;</span><span class="n">IAsyncFoo</span><span class="p">,</span> <span class="n">AsyncFoo</span><span class="p">&gt;();</span>

<span class="k">using</span> <span class="p">(</span><span class="n">container</span><span class="p">.</span><span class="n">BeginScope</span><span class="p">())</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">instance</span> <span class="p">=</span> <span class="n">container</span><span class="p">.</span><span class="n">GetInstance</span><span class="p">&lt;</span><span class="n">IAsyncFoo</span><span class="p">&gt;();</span>
    <span class="kt">var</span> <span class="n">bar</span> <span class="p">=</span> <span class="n">instance</span><span class="p">.</span><span class="n">GetBar</span><span class="p">().</span><span class="n">Result</span><span class="p">;</span>
    <span class="n">Assert</span><span class="p">.</span><span class="n">IsInstanceOfType</span><span class="p">(</span><span class="n">bar</span><span class="p">,</span> <span class="k">typeof</span><span class="p">(</span><span class="n">IBar</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div>


<blockquote>
<p>Note that the <strong>PerLogicalCallContextScopeManagerProvider</strong> is only available when running under .Net 4.5.
For more information, please refer to the following <a href="http://blog.stephencleary.com/2013/04/implicit-async-context-asynclocal.html">article</a> by Stephen Cleary.</p>
</blockquote>
<h2 id="scope">Scope<a class="headerlink" href="#scope" title="Permanent link">&para;</a></h2>
<p>The purpose of the scope is to track the services created within the scope. For instance, the <code>PerScopeLifetime</code> uses the scope to ensure that we only create a single service instance even if it requested multiple times.</p>
<p>One of the most canonical examples would be in a web application where we need to inject <code>IDbConnection</code> into different services. Let say that we have an <code>OrderController</code> and we need two services to process the order.</p>
<div class="codehilite"><pre><span></span><code><span class="k">public</span> <span class="k">class</span> <span class="nc">CustomerService</span> <span class="p">:</span> <span class="n">ICustomerService</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nf">CustomerService</span><span class="p">(</span><span class="n">IDbConnection</span> <span class="n">dbConnection</span><span class="p">)</span>
    <span class="p">{</span>    
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>


<div class="codehilite"><pre><span></span><code><span class="k">public</span> <span class="k">class</span> <span class="nc">OrderService</span> <span class="p">:</span> <span class="n">IOrderService</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nf">OrderService</span><span class="p">(</span><span class="n">IDbConnection</span> <span class="n">dbConnection</span><span class="p">)</span>
    <span class="p">{</span>     
    <span class="p">}</span>
<span class="p">}</span>  
</code></pre></div>


<div class="codehilite"><pre><span></span><code><span class="k">public</span> <span class="k">class</span> <span class="nc">OrderController</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nf">OrderController</span><span class="p">(</span><span class="n">ICustomerService</span> <span class="n">customerService</span><span class="p">,</span> <span class="n">IOrderService</span> <span class="n">orderService</span><span class="p">)</span>
  <span class="p">{</span>  
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>


<p>As we can see the <code>OrderController</code> depends on both the <code>CustomerService</code> and the <code>OrderService</code> which are both dependant upon an <code>IDbConnection</code>. </p>
<p>By registering the <code>IDbConnection</code> as a scoped service we ensure two things.</p>
<ul>
<li>Only a single instance of <code>IDbConnection</code> will ever be created inside a scope. </li>
<li>The <code>IDbConnection</code> instance is disposed when the scope ends.</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="n">container</span><span class="p">.</span><span class="n">RegisterScoped</span><span class="p">&lt;</span><span class="n">IDbConnection</span><span class="p">&gt;(</span><span class="n">factory</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="n">ProviderSpecificConnection</span><span class="p">());</span>
</code></pre></div>


<p>So when and how do we start these scopes?</p>
<p>She short answer is that most of the time, we don't. For instance, in AspNetCore, the scopes are started and ended by the AspNetCore infrastructure so we don't have to think about that when developing web application. A scope is started when the web request starts and it ended when the web request ends. It is really that simple, one request equals one scope.</p>
<p>So in <strong>LightInject</strong>, we register a scoped service using <code>RegisterScoped</code> without really thinking about when and how the scopes are started and ended. In a web application this usually means a web request, but for other applications it can mean something else. Maybe for a UI application it means a page/window/form or something similar. </p>
<p>To start a scope manually we can create scope using the <code>BeginScope</code> method</p>
<div class="codehilite"><pre><span></span><code><span class="k">using</span> <span class="p">(</span><span class="n">container</span><span class="p">.</span><span class="n">BeginScope</span><span class="p">())</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">dbConnection</span> <span class="p">=</span> <span class="n">container</span><span class="p">.</span><span class="n">GetInstance</span><span class="p">&lt;</span><span class="n">IDbConnection</span><span class="p">&gt;();</span>  
<span class="p">}</span>       
</code></pre></div>


<blockquote>
<p>Note: The <code>Scope</code> implement <code>IDisposable</code> and should always be wrapped in a using block to ensure its disposal</p>
</blockquote>
<p>In this example we start a new scope and retrieve the service from the container which means that <strong>LightInject</strong> uses the "current" scope to resolve the service. This is only supported for backwards compatibility and should be avoided if possible. The recommended approach is to retrieve services directly from the scope.</p>
<div class="codehilite"><pre><span></span><code><span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">scope</span> <span class="p">=</span> <span class="n">container</span><span class="p">.</span><span class="n">BeginScope</span><span class="p">())</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">dbConnection</span> <span class="p">=</span> <span class="n">scope</span><span class="p">.</span><span class="n">GetInstance</span><span class="p">&lt;</span><span class="n">IDbConnection</span><span class="p">&gt;();</span>  
<span class="p">}</span>   
</code></pre></div>


<p>Since we are retrieving the service directly from the scope, the current scope is ignored and we simply use the scope from which the service was requested. This is not only much faster, but it is also a much safer way to deal with scopes.</p>
<p>This also allows for multiple active scopes.</p>
<div class="codehilite"><pre><span></span><code><span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">outerScope</span> <span class="p">=</span> <span class="n">container</span><span class="p">.</span><span class="n">BeginScope</span><span class="p">())</span>
<span class="p">{</span>   
  <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">innerScope</span> <span class="p">=</span> <span class="n">container</span><span class="p">.</span><span class="n">BeginScope</span><span class="p">())</span>
  <span class="p">{</span>
        <span class="kt">var</span> <span class="n">outerDbConnection</span> <span class="p">=</span> <span class="n">outerScope</span><span class="p">.</span><span class="n">GetInstance</span><span class="p">&lt;</span><span class="n">IDbConnection</span><span class="p">&gt;();</span>
    <span class="kt">var</span> <span class="n">innerDbConnection</span> <span class="p">=</span> <span class="n">innerScope</span><span class="p">.</span><span class="n">GetInstance</span><span class="p">&lt;</span><span class="n">IDbConnection</span><span class="p">&gt;();</span>
  <span class="p">}</span>  
<span class="p">}</span>   
</code></pre></div>


<p>In addition to the <code>PerScopeLifetime</code> which ensures disposal and a single instance within a scope, we also have the <code>PerRequestLifetime</code>. This lifetime behaves just a transient meaning that we get a new instance for every time it is requested with the only difference to transients being that instances are disposed when the scope ends.</p>
<blockquote>
<p>Note: The <code>PerRequestLifetime</code> has NO relation to the notion of a web request. </p>
</blockquote>
<p>If we don't need access to an ambient scope, we can disable this in the <code>ContainerOptions</code></p>
<div class="codehilite"><pre><span></span><code><span class="kt">var</span> <span class="n">container</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ServiceContainer</span><span class="p">(</span><span class="n">o</span> <span class="p">=&gt;</span> <span class="n">o</span><span class="p">.</span><span class="n">EnableCurrentScope</span> <span class="p">=</span> <span class="k">false</span><span class="p">);</span>
</code></pre></div>


<p>This also improves performance ever so slightly as we don't need to maintain a current scope when scopes are started and ended. </p>
<h2 id="dependencies">Dependencies<a class="headerlink" href="#dependencies" title="Permanent link">&para;</a></h2>
<h3 id="constructor-injection">Constructor Injection<a class="headerlink" href="#constructor-injection" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="k">public</span> <span class="k">interface</span> <span class="n">IFoo</span> <span class="p">{}</span>        
<span class="k">public</span> <span class="k">interface</span> <span class="n">IBar</span> <span class="p">{}</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">Foo</span> <span class="p">:</span> <span class="n">IFoo</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nf">Foo</span><span class="p">(</span><span class="n">IBar</span> <span class="n">bar</span><span class="p">)</span> 
    <span class="p">{</span>
        <span class="n">Bar</span> <span class="p">=</span> <span class="n">bar</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="n">IBar</span> <span class="n">Bar</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span> 
<span class="p">}</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">Bar</span> <span class="p">:</span> <span class="n">IBar</span> <span class="p">{}</span>
</code></pre></div>


<h4 id="implicit-service-registration">Implicit service registration<a class="headerlink" href="#implicit-service-registration" title="Permanent link">&para;</a></h4>
<p>Registers a service without specifying any information about how to resolve the constructor dependencies of the implementing type.</p>
<div class="codehilite"><pre><span></span><code><span class="n">container</span><span class="p">.</span><span class="n">Register</span><span class="p">&lt;</span><span class="n">IFoo</span><span class="p">,</span> <span class="n">Foo</span><span class="p">&gt;();</span>
<span class="n">container</span><span class="p">.</span><span class="n">Register</span><span class="p">&lt;</span><span class="n">IBar</span><span class="p">,</span> <span class="n">Bar</span><span class="p">&gt;();</span>
<span class="kt">var</span> <span class="n">foo</span> <span class="p">=</span> <span class="p">(</span><span class="n">Foo</span><span class="p">)</span><span class="n">container</span><span class="p">.</span><span class="n">GetInstance</span><span class="p">&lt;</span><span class="n">IFoo</span><span class="p">&gt;();</span>
<span class="n">Assert</span><span class="p">.</span><span class="n">IsInstanceOfType</span><span class="p">(</span><span class="n">foo</span><span class="p">.</span><span class="n">Bar</span><span class="p">,</span> <span class="k">typeof</span><span class="p">(</span><span class="n">Bar</span><span class="p">));</span> 
</code></pre></div>


<blockquote>
<p>Note: In the case where the implementing type(Foo) has more than one constructor, <strong>LightInject</strong> will choose the constructor with the most parameters. </p>
</blockquote>
<p>For fine grained control of the injected constructor dependencies, we can provide a factory that makes it possible to create an instance of a given constructor dependency.</p>
<div class="codehilite"><pre><span></span><code><span class="n">container</span><span class="p">.</span><span class="n">RegisterConstructorDependency</span><span class="p">&lt;</span><span class="n">IBar</span><span class="p">&gt;((</span><span class="n">factory</span><span class="p">,</span> <span class="n">parameterInfo</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="n">Bar</span><span class="p">());</span>
</code></pre></div>


<p>This tells the container to inject a new <strong>Bar</strong> instance whenever it sees an <strong>IBar</strong> constructor dependency.</p>
<h4 id="explicit-service-registration">Explicit service registration<a class="headerlink" href="#explicit-service-registration" title="Permanent link">&para;</a></h4>
<p>Registers a service by providing explicit information about how to create the service instance and how to resolve the constructor dependencies.
​  <br />
​    container.Register<IBar, Bar>();
​    container.Register<IFoo>(factory =&gt; new Foo(factory.GetInstance<IBar>));
​    var foo = (Foo)container.GetInstance<IFoo>();
​    Assert.IsNotNull(foo.Bar);            </p>
<h4 id="parameters">Parameters<a class="headerlink" href="#parameters" title="Permanent link">&para;</a></h4>
<p>Parameters are used when we want to supply one or more values when the service is resolved.</p>
<div class="codehilite"><pre><span></span><code><span class="k">public</span> <span class="k">class</span> <span class="nc">Foo</span> <span class="p">:</span> <span class="n">IFoo</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nf">Foo</span><span class="p">(</span><span class="kt">int</span> <span class="k">value</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Value</span> <span class="p">=</span> <span class="k">value</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="kt">int</span> <span class="n">Value</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>   
</code></pre></div>


<hr />
<div class="codehilite"><pre><span></span><code><span class="n">container</span><span class="p">.</span><span class="n">Register</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">IFoo</span><span class="p">&gt;((</span><span class="n">arg</span><span class="p">,</span> <span class="n">factory</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="n">Foo</span><span class="p">(</span><span class="n">arg</span><span class="p">));</span>
<span class="kt">var</span> <span class="n">foo</span> <span class="p">=</span> <span class="p">(</span><span class="n">Foo</span><span class="p">)</span><span class="n">container</span><span class="p">.</span><span class="n">GetInstance</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">IFoo</span><span class="p">&gt;(</span><span class="m">42</span><span class="p">);</span>
<span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="m">42</span><span class="p">,</span><span class="n">foo</span><span class="p">.</span><span class="n">Value</span><span class="p">);</span>
</code></pre></div>


<p>We can also do a combination of supplied values and dependencies.</p>
<div class="codehilite"><pre><span></span><code><span class="k">public</span> <span class="k">class</span> <span class="nc">Foo</span> <span class="p">:</span> <span class="n">IFoo</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nf">Foo</span><span class="p">(</span><span class="kt">int</span> <span class="k">value</span><span class="p">,</span> <span class="n">IBar</span> <span class="n">bar</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Value</span> <span class="p">=</span> <span class="k">value</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="kt">int</span> <span class="n">Value</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="n">IBar</span> <span class="n">Bar</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>    
</code></pre></div>


<hr />
<div class="codehilite"><pre><span></span><code><span class="n">container</span><span class="p">.</span><span class="n">Register</span><span class="p">&lt;</span><span class="n">IBar</span><span class="p">,</span> <span class="n">Bar</span><span class="p">&gt;();</span>
<span class="n">container</span><span class="p">.</span><span class="n">Register</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">IFoo</span><span class="p">&gt;((</span><span class="n">factory</span><span class="p">,</span> <span class="k">value</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="n">Foo</span><span class="p">(</span><span class="k">value</span><span class="p">,</span> <span class="n">factory</span><span class="p">.</span><span class="n">GetInstance</span><span class="p">&lt;</span><span class="n">IBar</span><span class="p">&gt;()));</span>
<span class="kt">var</span> <span class="n">foo</span> <span class="p">=</span> <span class="p">(</span><span class="n">Foo</span><span class="p">)</span><span class="n">container</span><span class="p">.</span><span class="n">GetInstance</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">IFoo</span><span class="p">&gt;(</span><span class="m">42</span><span class="p">);</span>
<span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="m">42</span><span class="p">,</span> <span class="n">foo</span><span class="p">.</span><span class="n">Value</span><span class="p">);</span>
<span class="n">Assert</span><span class="p">.</span><span class="n">IsNotNull</span><span class="p">(</span><span class="n">foo</span><span class="p">.</span><span class="n">Bar</span><span class="p">);</span>
</code></pre></div>


<h4 id="optional-arguments">Optional arguments<a class="headerlink" href="#optional-arguments" title="Permanent link">&para;</a></h4>
<p>LightInject will allow for default values to be used when a constructor dependency cannot be resolved.</p>
<div class="codehilite"><pre><span></span><code><span class="k">public</span> <span class="k">class</span> <span class="nc">Foo</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nf">Foo</span><span class="p">(</span><span class="kt">string</span> <span class="k">value</span> <span class="p">=</span> <span class="s">&quot;42&quot;</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">Value</span> <span class="p">=</span> <span class="k">value</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">public</span> <span class="kt">string</span> <span class="n">Value</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>


<p>We can still resolve <code>Foo</code> even though we have not registered a <code>string</code> service. </p>
<div class="codehilite"><pre><span></span><code><span class="kt">var</span> <span class="n">container</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ServiceContainer</span><span class="p">(</span><span class="n">options</span> <span class="p">=&gt;</span> <span class="n">options</span><span class="p">.</span><span class="n">EnableOptionalArguments</span> <span class="p">=</span> <span class="k">true</span><span class="p">);</span>
<span class="n">container</span><span class="p">.</span><span class="n">Register</span><span class="p">&lt;</span><span class="n">Foo</span><span class="p">&gt;();</span>
<span class="kt">var</span> <span class="n">instance</span> <span class="p">=</span> <span class="n">container</span><span class="p">.</span><span class="n">GetInstance</span><span class="p">&lt;</span><span class="n">Foo</span><span class="p">&gt;();</span>
<span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="s">&quot;42&quot;</span><span class="p">,</span> <span class="n">instance</span><span class="p">.</span><span class="n">Value</span><span class="p">)</span>
</code></pre></div>


<blockquote>
<p>Note that the use cases for optional dependencies should be rare and are to be used with caution.</p>
</blockquote>
<h3 id="property-injection">Property Injection<a class="headerlink" href="#property-injection" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="k">public</span> <span class="k">interface</span> <span class="n">IFoo</span> <span class="p">{}</span>

<span class="k">public</span> <span class="k">interface</span> <span class="n">IBar</span> <span class="p">{}</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">Foo</span> <span class="p">:</span> <span class="n">IFoo</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="n">IBar</span> <span class="n">Bar</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</code></pre></div>


<div class="codehilite"><pre><span></span><code>}
</code></pre></div>


<div class="codehilite"><pre><span></span><code><span class="k">public</span> <span class="k">class</span> <span class="nc">Bar</span> <span class="p">:</span> <span class="n">IBar</span> <span class="p">{}</span>
</code></pre></div>


<h4 id="implicit-service-registration_1">Implicit service registration<a class="headerlink" href="#implicit-service-registration_1" title="Permanent link">&para;</a></h4>
<p>Registers the service without specifying any information about how to resolve the property dependencies.</p>
<div class="codehilite"><pre><span></span><code><span class="n">container</span><span class="p">.</span><span class="n">Register</span><span class="p">&lt;</span><span class="n">IFoo</span><span class="p">,</span> <span class="n">Foo</span><span class="p">&gt;();</span>
<span class="n">container</span><span class="p">.</span><span class="n">Register</span><span class="p">&lt;</span><span class="n">IBar</span><span class="p">,</span> <span class="n">Bar</span><span class="p">&gt;();</span>
<span class="kt">var</span> <span class="n">foo</span> <span class="p">=</span> <span class="p">(</span><span class="n">Foo</span><span class="p">)</span><span class="n">container</span><span class="p">.</span><span class="n">GetInstance</span><span class="p">&lt;</span><span class="n">IFoo</span><span class="p">&gt;();</span>
<span class="n">Assert</span><span class="p">.</span><span class="n">IsNotNull</span><span class="p">(</span><span class="n">foo</span><span class="p">.</span><span class="n">bar</span><span class="p">);</span>
</code></pre></div>


<blockquote>
<p><strong>Note:*<em> </em></strong>LightInject<strong> considers all read/write properties a dependency, but implements a loose strategy around property dependencies, meaning that it will </strong>NOT*<em> throw an exception in the case of an unresolved property dependency.</em>          </p>
</blockquote>
<p>For fine grained control of the injected property dependencies, we can provide a factory that makes it possible to create an instance of a given property dependency.</p>
<div class="codehilite"><pre><span></span><code><span class="n">container</span><span class="p">.</span><span class="n">RegisterPropertyDependency</span><span class="p">&lt;</span><span class="n">IBar</span><span class="p">&gt;((</span><span class="n">factory</span><span class="p">,</span> <span class="n">propertyInfo</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="n">Bar</span><span class="p">());</span>
</code></pre></div>


<p>This tells the container to inject a new <strong>Bar</strong> instance whenever it sees an <strong>IBar</strong> property dependency.</p>
<h4 id="explicit-service-registration_1">Explicit service registration<a class="headerlink" href="#explicit-service-registration_1" title="Permanent link">&para;</a></h4>
<p>Registers a service by providing explicit information about how to create the service instance and how to resolve the property dependencies.</p>
<div class="codehilite"><pre><span></span><code><span class="n">container</span><span class="p">.</span><span class="n">Register</span><span class="p">&lt;</span><span class="n">IBar</span><span class="p">,</span> <span class="n">Bar</span><span class="p">&gt;();</span>
<span class="n">container</span><span class="p">.</span><span class="n">Register</span><span class="p">&lt;</span><span class="n">IFoo</span><span class="p">&gt;(</span><span class="n">factory</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="n">Foo</span><span class="p">()</span> <span class="p">{</span><span class="n">Bar</span> <span class="p">=</span> <span class="n">factory</span><span class="p">.</span><span class="n">GetInstance</span><span class="p">&lt;</span><span class="n">IBar</span><span class="p">&gt;()})</span> 
<span class="kt">var</span> <span class="n">foo</span> <span class="p">=</span> <span class="p">(</span><span class="n">Foo</span><span class="p">)</span><span class="n">container</span><span class="p">.</span><span class="n">GetInstance</span><span class="p">&lt;</span><span class="n">IFoo</span><span class="p">&gt;();</span>
<span class="n">Assert</span><span class="p">.</span><span class="n">IsNotNull</span><span class="p">(</span><span class="n">foo</span><span class="p">.</span><span class="n">bar</span><span class="p">);</span>
</code></pre></div>


<h4 id="property-injection-on-existing-instances">Property injection on existing instances.<a class="headerlink" href="#property-injection-on-existing-instances" title="Permanent link">&para;</a></h4>
<p>In the cases where we don't control the creation of the service instance, <strong>LightInject</strong> can inject property dependencies into an existing instance.</p>
<div class="codehilite"><pre><span></span><code><span class="n">container</span><span class="p">.</span><span class="n">Register</span><span class="p">&lt;</span><span class="n">IBar</span><span class="p">,</span> <span class="n">Bar</span><span class="p">&gt;();</span>
<span class="kt">var</span> <span class="n">foo</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Foo</span><span class="p">();</span>
<span class="n">container</span><span class="p">.</span><span class="n">InjectProperties</span><span class="p">(</span><span class="n">foo</span><span class="p">);</span>
<span class="n">Assert</span><span class="p">.</span><span class="n">IsNotNull</span><span class="p">(</span><span class="n">foo</span><span class="p">);</span>
</code></pre></div>


<h4 id="disabling-properyinjection">Disabling ProperyInjection<a class="headerlink" href="#disabling-properyinjection" title="Permanent link">&para;</a></h4>
<p>Property injection is enabled by default in <strong>LightInject</strong>, but it can be disabled like this.</p>
<div class="codehilite"><pre><span></span><code><span class="kt">var</span> <span class="n">container</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ServiceContainer</span><span class="p">(</span><span class="k">new</span> <span class="n">ContainerOptions</span> <span class="p">{</span> <span class="n">EnablePropertyInjection</span> <span class="p">=</span> <span class="k">false</span> <span class="p">});</span>
</code></pre></div>


<blockquote>
<p>It is actually recommended to turn off property injection unless it is really needed. Backward compatibility is the only reason that this is not the default.</p>
</blockquote>
<h2 id="initializers">Initializers<a class="headerlink" href="#initializers" title="Permanent link">&para;</a></h2>
<p>Use the <strong>Initialize</strong> method to perform service instance initialization/post-processing.  </p>
<div class="codehilite"><pre><span></span><code><span class="n">container</span><span class="p">.</span><span class="n">Register</span><span class="p">&lt;</span><span class="n">IFoo</span><span class="p">,</span> <span class="n">FooWithPropertyDependency</span><span class="p">&gt;();</span>
<span class="n">container</span><span class="p">.</span><span class="n">Initialize</span><span class="p">(</span><span class="n">registration</span> <span class="p">=&gt;</span> <span class="n">registration</span><span class="p">.</span><span class="n">ServiceType</span> <span class="p">==</span> <span class="k">typeof</span><span class="p">(</span><span class="n">IFoo</span><span class="p">),</span> 
    <span class="p">(</span><span class="n">factory</span><span class="p">,</span> <span class="n">instance</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">((</span><span class="n">FooWithPropertyDependency</span><span class="p">)</span><span class="n">instance</span><span class="p">).</span><span class="n">Bar</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Bar</span><span class="p">());</span>
<span class="kt">var</span> <span class="n">foo</span> <span class="p">=</span> <span class="p">(</span><span class="n">FooWithProperyDependency</span><span class="p">)</span><span class="n">container</span><span class="p">.</span><span class="n">GetInstance</span><span class="p">&lt;</span><span class="n">IFoo</span><span class="p">&gt;();</span>
<span class="n">Assert</span><span class="p">.</span><span class="n">IsInstanceOfType</span><span class="p">(</span><span class="n">foo</span><span class="p">.</span><span class="n">Bar</span><span class="p">,</span> <span class="k">typeof</span><span class="p">(</span><span class="n">Bar</span><span class="p">));</span>
</code></pre></div>


<h2 id="assembly-scanning">Assembly Scanning<a class="headerlink" href="#assembly-scanning" title="Permanent link">&para;</a></h2>
<p>LightInject is capable of registering services by looking at the types of a given assembly.</p>
<div class="codehilite"><pre><span></span><code><span class="n">container</span><span class="p">.</span><span class="n">RegisterAssembly</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">IFoo</span><span class="p">).</span><span class="n">Assembly</span><span class="p">)</span>
</code></pre></div>


<p>To filter out the services to be registered with the container, we can provide a predicate that makes it possible to inspect the service type and the implementing type.</p>
<div class="codehilite"><pre><span></span><code><span class="n">container</span><span class="p">.</span><span class="n">RegisterAssembly</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">IFoo</span><span class="p">).</span><span class="n">Assembly</span><span class="p">,</span> <span class="p">(</span><span class="n">serviceType</span><span class="p">,</span> <span class="n">implementingType</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">serviceType</span><span class="p">.</span><span class="n">NameSpace</span> <span class="p">==</span> <span class="s">&quot;SomeNamespace&quot;</span><span class="p">);</span>
</code></pre></div>


<p>It is also possible to scan a set assembly files based on a search pattern.</p>
<div class="codehilite"><pre><span></span><code><span class="n">container</span><span class="p">.</span><span class="n">RegisterAssembly</span><span class="p">(</span><span class="s">&quot;SomeAssemblyName*.dll&quot;</span><span class="p">);</span>  
</code></pre></div>


<p>When scanning assemblies, <strong>LightInject</strong> will register services using a service name that by default is the implementing type name. This behavior can be changed by specifying a function delegate to provide the name based on the service type and the implementing type.</p>
<div class="codehilite"><pre><span></span><code><span class="n">container</span><span class="p">.</span><span class="n">RegisterAssembly</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">IFoo</span><span class="p">).</span><span class="n">Assembly</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="n">PerContainerLifetime</span><span class="p">(),</span> <span class="p">(</span><span class="n">serviceType</span><span class="p">,</span> <span class="n">implementingType</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">serviceType</span><span class="p">.</span><span class="n">NameSpace</span> <span class="p">==</span> <span class="s">&quot;SomeNamespace&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">serviceType</span><span class="p">,</span> <span class="n">implementingType</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="s">&quot;Provide custom service name here&quot;</span><span class="p">);</span>
</code></pre></div>


<p>We can also change this behavior globally for all registrations by implementing the <strong>IServiceNameProvider</strong> interface.</p>
<div class="codehilite"><pre><span></span><code><span class="k">public</span> <span class="k">class</span> <span class="nc">CustomServiceNameProvider</span> <span class="p">:</span> <span class="n">IServiceNameProvider</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="nf">GetServiceName</span><span class="p">(</span><span class="n">Type</span> <span class="n">serviceType</span><span class="p">,</span> <span class="n">Type</span> <span class="n">implementingType</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="s">&quot;Provide custom service name here&quot;</span><span class="p">;</span>  
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>


<p>To change the default behavior for all registrations we simply change this dependency on the container before we start scanning assemblies.</p>
<div class="codehilite"><pre><span></span><code><span class="n">container</span><span class="p">.</span><span class="n">ServiceNameProvider</span> <span class="p">=</span> <span class="k">new</span> <span class="n">CustomServiceNameProvider</span><span class="p">();</span>
</code></pre></div>


<h2 id="composition-root">Composition Root<a class="headerlink" href="#composition-root" title="Permanent link">&para;</a></h2>
<p>When <strong>LightInject</strong> scans an assembly it will look for an implementation of the <strong>ICompositionRoot</strong> interface.   </p>
<div class="codehilite"><pre><span></span><code><span class="k">public</span> <span class="k">class</span> <span class="nc">SampleCompositionRoot</span> <span class="p">:</span> <span class="n">ICompositionRoot</span>
<span class="p">{</span>               
    <span class="k">public</span> <span class="k">void</span> <span class="nf">Compose</span><span class="p">(</span><span class="n">IServiceRegistry</span> <span class="n">serviceRegistry</span><span class="p">)</span>
    <span class="p">{</span>     
        <span class="n">serviceRegistry</span><span class="p">.</span><span class="n">Register</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">IFoo</span><span class="p">),</span><span class="k">typeof</span><span class="p">(</span><span class="n">Foo</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>


<p>If one or more implementations of the <strong>ICompositionRoot</strong> interface is found, they will be created and executed.</p>
<blockquote>
<p><strong>Note:</strong> <em>Any other services contained within the target assembly that is not registered in the composition root, will </em><em>NOT</em><em> be registered.</em></p>
</blockquote>
<p>Rather that having a single composition root that basically needs to reference all other assemblies, having multiple composition roots makes it possible to group services naturally together. Another advantage of registering services in a <strong>ICompositionRoot</strong>, is that they can easily be reused in automated tests.   </p>
<h3 id="lazy-composition-roots">Lazy Composition Roots<a class="headerlink" href="#lazy-composition-roots" title="Permanent link">&para;</a></h3>
<p><strong>LightInject</strong> is capable of registering services on a need to have basis. For a large application that has a lot of services, it might not be the best solution to register all these services up front as this could seriously hurt the startup time of our application due to extensive assembly loading.</p>
<p>If an unregistered service is requested, <strong>LightInject</strong> will scan the assembly where this service is contained.  </p>
<h3 id="compositionrootattribute">CompositionRootAttribute<a class="headerlink" href="#compositionrootattribute" title="Permanent link">&para;</a></h3>
<p>When an assembly is being scanned, <strong>LightInject</strong> will look for implementations of the <strong>ICompositionRoot</strong> interface. For large assemblies that contains many type, this might be an expensive operation. The <strong>CompositionRootAttribute</strong> is an assembly level attribute that simply helps <strong>LightInject</strong> to locate the compostion root.</p>
<div class="codehilite"><pre><span></span><code><span class="na">[assembly: CompositionRootType(typeof(SampleCompositionRoot))]</span>
</code></pre></div>


<h3 id="registerfrom">RegisterFrom<a class="headerlink" href="#registerfrom" title="Permanent link">&para;</a></h3>
<p>Allows explicit execution of a composition root.</p>
<div class="codehilite"><pre><span></span><code><span class="n">container</span><span class="p">.</span><span class="n">RegisterFrom</span><span class="p">&lt;</span><span class="n">SampleCompositionRoot</span><span class="p">&gt;();</span>
</code></pre></div>


<h2 id="generics">Generics<a class="headerlink" href="#generics" title="Permanent link">&para;</a></h2>
<div class="codehilite"><pre><span></span><code><span class="k">public</span> <span class="k">interface</span> <span class="n">IFoo</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="p">{};</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">Foo</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="p">:</span> <span class="n">IFoo</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="p">{};</span>
</code></pre></div>


<p>The container creates the closed generic type based on the service request.</p>
<div class="codehilite"><pre><span></span><code><span class="n">container</span><span class="p">.</span><span class="n">Register</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">IFoo</span><span class="p">&lt;&gt;),</span> <span class="k">typeof</span><span class="p">(</span><span class="n">Foo</span><span class="p">&lt;&gt;));</span>
<span class="kt">var</span> <span class="n">instance</span> <span class="p">=</span> <span class="n">container</span><span class="p">.</span><span class="n">GetInstance</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">IFoo</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;));</span>
<span class="n">Assert</span><span class="p">.</span><span class="n">IsInstanceOfType</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="k">typeof</span><span class="p">(</span><span class="n">Foo</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;));</span>
</code></pre></div>


<h3 id="constraints">Constraints<a class="headerlink" href="#constraints" title="Permanent link">&para;</a></h3>
<p><strong>LightInject</strong> enforces generic constrains  </p>
<h2 id="lazyt">Lazy&lt;T&gt;<a class="headerlink" href="#lazyt" title="Permanent link">&para;</a></h2>
<p><strong>LightInject</strong> can resolve a service as an instance of <a href="http://msdn.microsoft.com/en-us/library/dd642331.aspx">Lazy&lt;T&gt;</a> when we want to postpone resolving the underlying service until it is needed.</p>
<div class="codehilite"><pre><span></span><code><span class="k">public</span> <span class="k">interface</span> <span class="n">IFoo</span> <span class="p">{}</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">Foo</span> <span class="p">:</span> <span class="n">IFoo</span> <span class="p">{}</span>
</code></pre></div>


<hr />
<div class="codehilite"><pre><span></span><code><span class="n">container</span><span class="p">.</span><span class="n">Register</span><span class="p">&lt;</span><span class="n">IFoo</span><span class="p">,</span> <span class="n">Foo</span><span class="p">&gt;();</span>
<span class="kt">var</span> <span class="n">lazyFoo</span> <span class="p">=</span> <span class="n">container</span><span class="p">.</span><span class="n">GetInstance</span><span class="p">&lt;</span><span class="n">Lazy</span><span class="p">&lt;</span><span class="n">IFoo</span><span class="p">&gt;&gt;();</span>
<span class="n">Assert</span><span class="p">.</span><span class="n">IsNotNull</span><span class="p">(</span><span class="n">lazyFoo</span><span class="p">.</span><span class="n">Value</span><span class="p">);</span>
</code></pre></div>


<h2 id="function-factories">Function Factories<a class="headerlink" href="#function-factories" title="Permanent link">&para;</a></h2>
<p>Function factories allows services to resolved as a function delegate that in turn is capable of returning the underlying service instance. We can think of this as an alternative to the <a href="http://en.wikipedia.org/wiki/Service_locator_pattern">Service Locator</a> (anti)pattern.</p>
<div class="codehilite"><pre><span></span><code><span class="k">public</span> <span class="k">interface</span> <span class="n">IFoo</span> <span class="p">{}</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">Foo</span> <span class="p">:</span> <span class="n">IFoo</span> <span class="p">{}</span>
</code></pre></div>


<hr />
<div class="codehilite"><pre><span></span><code><span class="n">container</span><span class="p">.</span><span class="n">Register</span><span class="p">&lt;</span><span class="n">IFoo</span><span class="p">,</span><span class="n">Foo</span><span class="p">&gt;();</span>
<span class="kt">var</span> <span class="n">func</span> <span class="p">=</span> <span class="n">container</span><span class="p">.</span><span class="n">GetInstance</span><span class="p">&lt;</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">IFoo</span><span class="p">&gt;&gt;();</span>
<span class="kt">var</span> <span class="n">foo</span> <span class="p">=</span> <span class="n">func</span><span class="p">();</span>
<span class="n">Assert</span><span class="p">.</span><span class="n">IsNotNull</span><span class="p">(</span><span class="n">foo</span><span class="p">);</span> 
</code></pre></div>


<blockquote>
<p><strong>Note:</strong> <em>A function factory is effectively a delegate that redirects back to the corresponding </em><em>GetInstance</em><em> method on the service container.</em></p>
</blockquote>
<h3 id="named-factories">Named Factories<a class="headerlink" href="#named-factories" title="Permanent link">&para;</a></h3>
<p>The container returns a function delegate that represents calling the <strong>GetInstance</strong> method with "SomeFoo" as the service name argument.</p>
<div class="codehilite"><pre><span></span><code><span class="n">container</span><span class="p">.</span><span class="n">Register</span><span class="p">&lt;</span><span class="n">IFoo</span><span class="p">,</span> <span class="n">Foo</span><span class="p">&gt;(</span><span class="s">&quot;SomeFoo&quot;</span><span class="p">);</span>
<span class="kt">var</span> <span class="n">func</span> <span class="p">=</span> <span class="n">container</span><span class="p">.</span><span class="n">GetInstance</span><span class="p">&lt;</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">IFoo</span><span class="p">&gt;&gt;(</span><span class="s">&quot;SomeFoo&quot;</span><span class="p">);</span>   
<span class="kt">var</span> <span class="n">foo</span> <span class="p">=</span> <span class="n">func</span><span class="p">();</span>
<span class="n">Assert</span><span class="p">.</span><span class="n">IsNotNull</span><span class="p">(</span><span class="n">foo</span><span class="p">);</span>
</code></pre></div>


<h3 id="parameters_1">Parameters<a class="headerlink" href="#parameters_1" title="Permanent link">&para;</a></h3>
<p>Function factories can also take parameters that will be used create the service instance.</p>
<div class="codehilite"><pre><span></span><code><span class="k">public</span> <span class="k">class</span> <span class="nc">Foo</span> <span class="p">:</span> <span class="n">IFoo</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nf">Foo</span><span class="p">(</span><span class="kt">int</span> <span class="k">value</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Value</span> <span class="p">=</span> <span class="k">value</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="kt">int</span> <span class="n">Value</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>


<hr />
<div class="codehilite"><pre><span></span><code><span class="n">container</span><span class="p">.</span><span class="n">Register</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">IFoo</span><span class="p">&gt;((</span><span class="n">factory</span><span class="p">,</span> <span class="k">value</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="n">Foo</span><span class="p">(</span><span class="k">value</span><span class="p">));</span>
<span class="kt">var</span> <span class="n">fooFactory</span> <span class="p">=</span> <span class="n">container</span><span class="p">.</span><span class="n">GetInstance</span><span class="p">&lt;</span><span class="n">Func</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">IFoo</span><span class="p">&gt;&gt;();</span>
<span class="kt">var</span> <span class="n">foo</span> <span class="p">=</span> <span class="p">(</span><span class="n">Foo</span><span class="p">)</span><span class="n">fooFactory</span><span class="p">(</span><span class="m">42</span><span class="p">);</span> 
<span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="n">foo</span><span class="p">.</span><span class="n">Value</span><span class="p">,</span> <span class="m">42</span><span class="p">);</span>
</code></pre></div>


<blockquote>
<p><strong>Note</strong> : <em>The service must be explicitly registered in order for the container to resolve it as a parameterized function factory.</em></p>
</blockquote>
<h3 id="idisposable">IDisposable<a class="headerlink" href="#idisposable" title="Permanent link">&para;</a></h3>
<p>The only way to deal with disposable objects when using function factories, is to let the service type inherit from IDisposable.</p>
<div class="codehilite"><pre><span></span><code><span class="k">public</span> <span class="k">interface</span> <span class="n">IFoo</span> <span class="p">:</span> <span class="n">IDisposable</span> <span class="p">{}</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">Foo</span> <span class="p">:</span> <span class="n">IFoo</span> <span class="p">{}</span>
</code></pre></div>


<hr />
<div class="codehilite"><pre><span></span><code><span class="n">container</span><span class="p">.</span><span class="n">Register</span><span class="p">&lt;</span><span class="n">IFoo</span><span class="p">,</span> <span class="n">Foo</span><span class="p">&gt;();</span>
<span class="kt">var</span> <span class="n">fooFactory</span> <span class="p">=</span> <span class="n">container</span><span class="p">.</span><span class="n">GetInstance</span><span class="p">&lt;</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">IFoo</span><span class="p">&gt;&gt;();</span>

<span class="n">using</span><span class="p">(</span><span class="n">IFoo</span> <span class="n">foo</span> <span class="p">=</span> <span class="n">fooFactory</span><span class="p">())</span>
<span class="p">{</span>

<span class="p">}</span> <span class="p">&lt;--</span><span class="n">Instance</span> <span class="k">is</span> <span class="n">disposed</span> <span class="n">here</span>          
</code></pre></div>


<blockquote>
<p><strong>Note:</strong> <em>Although this is common practice even in the <a href="http://en.wikipedia.org/wiki/Base_Class_Library">BCL</a>, this kind of interfaces are often referred to as <a href="http://en.wikipedia.org/wiki/Leaky_abstraction">leaky abstractions</a>.</em></p>
</blockquote>
<h2 id="typed-factories">Typed Factories<a class="headerlink" href="#typed-factories" title="Permanent link">&para;</a></h2>
<p>A typed factory is a class that wraps the function factory that is used to create the underlying service instance.
As opposed to just function factories, typed factories provides better expressiveness to the consumer of the factory.  </p>
<div class="codehilite"><pre><span></span><code><span class="k">public</span> <span class="k">interface</span> <span class="n">IFooFactory</span>
<span class="p">{</span>
    <span class="n">IFoo</span> <span class="nf">GetFoo</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>


<hr />
<div class="codehilite"><pre><span></span><code><span class="k">public</span> <span class="k">class</span> <span class="nc">FooFactory</span> <span class="p">:</span> <span class="n">IFooFactory</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="n">Func</span><span class="p">&lt;</span><span class="n">IFoo</span><span class="p">&gt;</span> <span class="n">createFoo</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">FooFactory</span><span class="p">(</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">IFoo</span><span class="p">&gt;</span> <span class="n">createFoo</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">createFoo</span> <span class="p">=</span> <span class="n">createFoo</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="n">IFoo</span> <span class="nf">GetFoo</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nf">createFoo</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span> 
</code></pre></div>


<hr />
<div class="codehilite"><pre><span></span><code><span class="n">container</span><span class="p">.</span><span class="n">Register</span><span class="p">&lt;</span><span class="n">IFoo</span><span class="p">,</span> <span class="n">Foo</span><span class="p">&gt;();</span>
<span class="n">container</span><span class="p">.</span><span class="n">Register</span><span class="p">&lt;</span><span class="n">IFooFactory</span><span class="p">,</span> <span class="n">FooFactory</span><span class="p">&gt;(</span><span class="k">new</span> <span class="n">PerContainerLifetime</span><span class="p">());</span>
<span class="kt">var</span> <span class="n">fooFactory</span> <span class="p">=</span> <span class="n">container</span><span class="p">.</span><span class="n">GetInstance</span><span class="p">&lt;</span><span class="n">IFooFactory</span><span class="p">&gt;();</span>
<span class="kt">var</span> <span class="n">foo</span> <span class="p">=</span> <span class="n">fooFactory</span><span class="p">.</span><span class="n">GetFoo</span><span class="p">();</span>
<span class="n">Assert</span><span class="p">.</span><span class="n">IsNotNull</span><span class="p">(</span><span class="n">foo</span><span class="p">);</span>
</code></pre></div>


<blockquote>
<p><strong>Note:</strong> <em>Register typed factories with the </em><em>PerContainerLifetime</em><em> unless a compelling reason exists to choose a different lifetime.</em>  </p>
</blockquote>
<h3 id="parameters_2">Parameters<a class="headerlink" href="#parameters_2" title="Permanent link">&para;</a></h3>
<p>Types factories can also wrap a parameterized function factory and allows us to pass arguments.</p>
<div class="codehilite"><pre><span></span><code><span class="k">public</span> <span class="k">class</span> <span class="nc">Foo</span> <span class="p">:</span> <span class="n">IFoo</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nf">Foo</span><span class="p">(</span><span class="kt">int</span> <span class="k">value</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Value</span> <span class="p">=</span> <span class="k">value</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="kt">int</span> <span class="n">Value</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">interface</span> <span class="n">IFooFactory</span>
<span class="p">{</span>
    <span class="n">IFoo</span> <span class="nf">GetFoo</span><span class="p">(</span><span class="kt">int</span> <span class="k">value</span><span class="p">);</span>
<span class="p">}</span> 
</code></pre></div>


<hr />
<div class="codehilite"><pre><span></span><code><span class="k">public</span> <span class="k">class</span> <span class="nc">FooFactory</span> <span class="p">:</span> <span class="n">IFooFactory</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="n">Func</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">IFoo</span><span class="p">&gt;</span> <span class="n">createFoo</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">FooFactory</span><span class="p">(</span><span class="n">Func</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">IFoo</span><span class="p">&gt;</span> <span class="n">createFoo</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">createFoo</span> <span class="p">=</span> <span class="n">createFoo</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="n">IFoo</span> <span class="nf">GetFoo</span><span class="p">(</span><span class="kt">int</span> <span class="k">value</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nf">createFoo</span><span class="p">(</span><span class="k">value</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span> 
</code></pre></div>


<hr />
<div class="codehilite"><pre><span></span><code><span class="n">container</span><span class="p">.</span><span class="n">Register</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">IFoo</span><span class="p">&gt;((</span><span class="n">factory</span><span class="p">,</span> <span class="k">value</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="n">Foo</span><span class="p">(</span><span class="k">value</span><span class="p">));</span>
<span class="n">container</span><span class="p">.</span><span class="n">Register</span><span class="p">&lt;</span><span class="n">IFooFactory</span><span class="p">,</span> <span class="n">FooFactory</span><span class="p">&gt;(</span><span class="k">new</span> <span class="n">PerContainerLifetime</span><span class="p">());</span>
<span class="kt">var</span> <span class="n">typedFooFactory</span> <span class="p">=</span> <span class="n">container</span><span class="p">.</span><span class="n">GetInstance</span><span class="p">&lt;</span><span class="n">IFooFactory</span><span class="p">&gt;();</span>
<span class="kt">var</span> <span class="n">foo</span> <span class="p">=</span> <span class="n">typedFooFactory</span><span class="p">.</span><span class="n">GetFoo</span><span class="p">(</span><span class="m">42</span><span class="p">);</span>
<span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="n">foo</span><span class="p">.</span><span class="n">Value</span><span class="p">,</span> <span class="m">42</span><span class="p">);</span>
</code></pre></div>


<h3 id="idisposable_1">IDisposable<a class="headerlink" href="#idisposable_1" title="Permanent link">&para;</a></h3>
<p>Working with typed factories gives us the possibility to release disposable services registered as transients without exposing a leaky abstraction.</p>
<div class="codehilite"><pre><span></span><code><span class="k">public</span> <span class="k">interface</span> <span class="n">IFooFactory</span>
<span class="p">{</span>
    <span class="n">IFoo</span> <span class="nf">GetFoo</span><span class="p">(</span><span class="kt">int</span> <span class="k">value</span><span class="p">);</span>
    <span class="k">void</span> <span class="nf">Release</span><span class="p">(</span><span class="n">IFoo</span> <span class="n">foo</span><span class="p">);</span>
<span class="p">}</span> 
</code></pre></div>


<hr />
<div class="codehilite"><pre><span></span><code><span class="k">public</span> <span class="k">class</span> <span class="nc">FooFactory</span> <span class="p">:</span> <span class="n">IFooFactory</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="n">Func</span><span class="p">&lt;</span><span class="n">IFoo</span><span class="p">&gt;</span> <span class="n">createFoo</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">FooFactory</span><span class="p">(</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">IFoo</span><span class="p">&gt;</span> <span class="n">createFoo</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">createFoo</span> <span class="p">=</span> <span class="n">createFoo</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="n">IFoo</span> <span class="nf">GetFoo</span><span class="p">(</span><span class="kt">int</span> <span class="k">value</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nf">createFoo</span><span class="p">(</span><span class="k">value</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">Release</span><span class="p">(</span><span class="n">IFoo</span> <span class="n">foo</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">disposable</span> <span class="p">=</span> <span class="n">foo</span> <span class="k">as</span> <span class="n">IDisposable</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">disposable</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">disposable</span><span class="p">.</span><span class="n">Dispose</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>    
</code></pre></div>


<h2 id="recursive-dependency-detection">Recursive dependency detection<a class="headerlink" href="#recursive-dependency-detection" title="Permanent link">&para;</a></h2>
<p>A recursive dependency graph is when a service depends directly or indirectly on itself.</p>
<div class="codehilite"><pre><span></span><code><span class="k">public</span> <span class="k">class</span> <span class="nc">FooWithRecursiveDependency</span> <span class="p">:</span> <span class="n">IFoo</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nf">FooWithRecursiveDependency</span><span class="p">(</span><span class="n">IFoo</span> <span class="n">foo</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>


<p>The following code will throw an <strong>InvalidOperationException</strong> stating that there are existing recursive dependencies. </p>
<div class="codehilite"><pre><span></span><code><span class="n">container</span><span class="p">.</span><span class="n">Register</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">IFoo</span><span class="p">),</span> <span class="k">typeof</span><span class="p">(</span><span class="n">FooWithRecursiveDependency</span><span class="p">));</span>
<span class="n">container</span><span class="p">.</span><span class="n">GetInstance</span><span class="p">&lt;</span><span class="n">IFoo</span><span class="p">&gt;()</span>
</code></pre></div>


<h2 id="internals">Internals<a class="headerlink" href="#internals" title="Permanent link">&para;</a></h2>
<p>When running under the .Net platform, <strong>LightInject</strong> is capable of creating instances of classes that has the <a href="http://msdn.microsoft.com/en-us/library/7c5ka91b.aspx">internal</a> modifier. </p>
<p>The only requirement is that the internal class exposes a public constructor.</p>
<div class="codehilite"><pre><span></span><code><span class="k">internal</span> <span class="k">class</span> <span class="nc">InternalFooWithPublicConstructor</span> <span class="p">:</span> <span class="n">IFoo</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nf">InternalFooWithPublicConstructor</span> <span class="p">()</span> <span class="p">{}</span>
<span class="p">}</span>
</code></pre></div>


<h2 id="logging">Logging<a class="headerlink" href="#logging" title="Permanent link">&para;</a></h2>
<p>Sometimes it might be useful to obtain information about what is going on inside the container 
and <strong>LightInject</strong> provides a very simple log abstraction that is used to log information and warnings from within the container.</p>
<div class="codehilite"><pre><span></span><code><span class="kt">var</span> <span class="n">containerOptions</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ContainerOptions</span><span class="p">();</span>
<span class="n">containerOptions</span><span class="p">.</span><span class="n">LogFactory</span> <span class="p">=</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">logEntry</span> <span class="p">=&gt;</span> <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">logEntry</span><span class="p">.</span><span class="n">Message</span><span class="p">);</span>
</code></pre></div>


<h2 id="unit-testing">Unit Testing<a class="headerlink" href="#unit-testing" title="Permanent link">&para;</a></h2>
<p>Sometimes it might be useful to use the service container within our unit tests. LightInject also provides the <a href="https://www.nuget.org/packages/LightInject.xUnit/">LightInject.xUnit</a> extension that enables dependencies to be injected into test methods. One side effect of using that extension is that it is tightly coupled to xUnit and it we have less control with regards to container instances. </p>
<p>Instead consider this simple base class </p>
<div class="codehilite"><pre><span></span><code><span class="k">public</span> <span class="k">class</span> <span class="nc">ContainerFixture</span> <span class="p">:</span> <span class="n">IDisposable</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nf">ContainerFixture</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">container</span> <span class="p">=</span> <span class="n">CreateContainer</span><span class="p">();</span>
        <span class="n">Configure</span><span class="p">(</span><span class="n">container</span><span class="p">);</span>
        <span class="n">container</span><span class="p">.</span><span class="n">RegisterFrom</span><span class="p">&lt;</span><span class="n">CompositionRoot</span><span class="p">&gt;();</span>
        <span class="n">ServiceFactory</span> <span class="p">=</span> <span class="n">container</span><span class="p">.</span><span class="n">BeginScope</span><span class="p">();</span>
        <span class="n">InjectPrivateFields</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">void</span> <span class="nf">InjectPrivateFields</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">privateInstanceFields</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">GetType</span><span class="p">().</span><span class="n">GetFields</span><span class="p">(</span><span class="n">BindingFlags</span><span class="p">.</span><span class="n">Public</span> <span class="p">|</span> <span class="n">BindingFlags</span><span class="p">.</span><span class="n">NonPublic</span> <span class="p">|</span> <span class="n">BindingFlags</span><span class="p">.</span><span class="n">Instance</span><span class="p">);</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">privateInstanceField</span> <span class="k">in</span> <span class="n">privateInstanceFields</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">privateInstanceField</span><span class="p">.</span><span class="n">SetValue</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">GetInstance</span><span class="p">(</span><span class="n">ServiceFactory</span><span class="p">,</span> <span class="n">privateInstanceField</span><span class="p">));</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">internal</span> <span class="n">Scope</span> <span class="n">ServiceFactory</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">Dispose</span><span class="p">()</span> <span class="p">=&gt;</span> <span class="n">ServiceFactory</span><span class="p">.</span><span class="n">Dispose</span><span class="p">();</span>

    <span class="k">public</span> <span class="n">TService</span> <span class="n">GetInstance</span><span class="p">&lt;</span><span class="n">TService</span><span class="p">&gt;(</span><span class="kt">string</span> <span class="n">name</span> <span class="p">=</span> <span class="s">&quot;&quot;</span><span class="p">)</span>
        <span class="p">=&gt;</span> <span class="n">ServiceFactory</span><span class="p">.</span><span class="n">GetInstance</span><span class="p">&lt;</span><span class="n">TService</span><span class="p">&gt;(</span><span class="n">name</span><span class="p">);</span>

    <span class="k">private</span> <span class="kt">object</span> <span class="nf">GetInstance</span><span class="p">(</span><span class="n">IServiceFactory</span> <span class="n">factory</span><span class="p">,</span> <span class="n">FieldInfo</span> <span class="n">field</span><span class="p">)</span>
        <span class="p">=&gt;</span> <span class="n">ServiceFactory</span><span class="p">.</span><span class="n">TryGetInstance</span><span class="p">(</span><span class="n">field</span><span class="p">.</span><span class="n">FieldType</span><span class="p">)</span> <span class="p">??</span> <span class="n">ServiceFactory</span><span class="p">.</span><span class="n">GetInstance</span><span class="p">(</span><span class="n">field</span><span class="p">.</span><span class="n">FieldType</span><span class="p">,</span> <span class="n">field</span><span class="p">.</span><span class="n">Name</span><span class="p">);</span>

    <span class="k">internal</span> <span class="k">virtual</span> <span class="n">IServiceContainer</span> <span class="nf">CreateContainer</span><span class="p">()</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="n">ServiceContainer</span><span class="p">();</span>

    <span class="k">internal</span> <span class="k">virtual</span> <span class="k">void</span> <span class="nf">Configure</span><span class="p">(</span><span class="n">IServiceRegistry</span> <span class="n">serviceRegistry</span><span class="p">)</span> <span class="p">{}</span>
<span class="p">}</span>
</code></pre></div>


<p>This can be use with any test framework as long as it creates a new instance of the test class for each test method and that it calls <code>Dispose</code> after the test completes. For <code>xUnit</code> this is the default behaviour.</p>
<p>Injecting services now becomes incredible easy. Just declare the service to test as a private field like this.</p>
<div class="codehilite"><pre><span></span><code><span class="k">public</span> <span class="k">class</span> <span class="nc">SampleTests</span> <span class="p">:</span> <span class="n">ContainerFixture</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="n">ICalculator</span> <span class="n">calculator</span><span class="p">;</span>

<span class="na">    [Fact]</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">ShouldAddNumbers</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">calculator</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="m">2</span><span class="p">).</span><span class="n">ShouldBe</span><span class="p">(</span><span class="m">2</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>


<p>If we need to configure the container before executing the test, we can do that by simply overriding the <code>Configure</code> method. This could for instance be used to register mock services into the container.</p>
<div class="codehilite"><pre><span></span><code><span class="k">public</span> <span class="k">class</span> <span class="nc">SampleTests</span> <span class="p">:</span> <span class="n">ContainerFixture</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="n">ICalculator</span> <span class="n">calculator</span><span class="p">;</span>

<span class="na">    [Fact]</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">ShouldAddNumbers</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">calculator</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="m">2</span><span class="p">).</span><span class="n">ShouldBe</span><span class="p">(</span><span class="m">2</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">internal</span> <span class="k">override</span> <span class="nf">Configure</span><span class="p">(</span><span class="n">IServiceRegistry</span> <span class="n">serviceRegistry</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// Add registrations related to testing here</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
                
                  
                
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
        
          <a href="designpatterns/" title="Patterns" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Patterns
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org" target="_blank" rel="noopener">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="assets/javascripts/application.c33a9706.js"></script>
      
      <script>app.initialize({version:"1.1",url:{base:"."}})</script>
      
    
  </body>
</html>