



<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-3.1.0">
    
    
      
        <title>Web Api Request Logging - LightInject</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.11e41852.css">
      
      
    
    
      <script src="../assets/javascripts/modernizr.20ef595d.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="__github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#web-api-request-logging" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href=".." title="LightInject" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                LightInject
              </span>
              <span class="md-header-nav__topic">
                Web Api Request Logging
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  


  <a href="https://github.com/seesharper/lightinject/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#__github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      GitHub
    </div>
  </a>

          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href=".." title="LightInject" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    LightInject
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://github.com/seesharper/lightinject/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#__github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      GitHub
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../designpatterns/" title="Patterns" class="md-nav__link">
      Patterns
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Extensions
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Extensions
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../interception/" title="Interception" class="md-nav__link">
      Interception
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../autofactory/" title="AutoFactory" class="md-nav__link">
      AutoFactory
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../annotation/" title="Annotation" class="md-nav__link">
      Annotation
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      Integrations
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Integrations
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../xunit/" title="xUnit" class="md-nav__link">
      xUnit
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../web/" title="Web" class="md-nav__link">
      Web
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../mvc/" title="Mvc" class="md-nav__link">
      Mvc
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../wcf/" title="WCF" class="md-nav__link">
      WCF
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../webapi/" title="Web Api" class="md-nav__link">
      Web Api
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../signalr/" title="SignalR" class="md-nav__link">
      SignalR
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../nancy/" title="Nancy" class="md-nav__link">
      Nancy
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../microsoft.aspnetcore.hosting/" title="AspNetCore" class="md-nav__link">
      AspNetCore
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../microsoft.dependencyinjection/" title="Microsoft DI" class="md-nav__link">
      Microsoft DI
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5" checked>
    
    <label class="md-nav__link" for="nav-5">
      Blog
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        Blog
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Web Api Request Logging
      </label>
    
    <a href="./" title="Web Api Request Logging" class="md-nav__link md-nav__link--active">
      Web Api Request Logging
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#logging" title="Logging" class="md-nav__link">
    Logging
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#composition-root" title="Composition root" class="md-nav__link">
    Composition root
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#controllers" title="Controllers" class="md-nav__link">
    Controllers
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#request-logging" title="Request logging" class="md-nav__link">
    Request logging
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#request-context" title="Request Context" class="md-nav__link">
    Request Context
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#decorators" title="Decorators" class="md-nav__link">
    Decorators
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../transactions/" title="Transactions and Testing" class="md-nav__link">
      Transactions and Testing
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../aspnetcoreunittesting/" title="AspNetCore unit testing" class="md-nav__link">
      AspNetCore unit testing
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../blog-dotnet-steps/" title="Making of dotnet-steps" class="md-nav__link">
      Making of dotnet-steps
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      Side Projects
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        Side Projects
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../lightmock/" title="LightMock" class="md-nav__link">
      LightMock
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7">
    
    <label class="md-nav__link" for="nav-7">
      About
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-7">
        About
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../licence/" title="Licence" class="md-nav__link">
      Licence
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#logging" title="Logging" class="md-nav__link">
    Logging
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#composition-root" title="Composition root" class="md-nav__link">
    Composition root
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#controllers" title="Controllers" class="md-nav__link">
    Controllers
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#request-logging" title="Request logging" class="md-nav__link">
    Request logging
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#request-context" title="Request Context" class="md-nav__link">
    Request Context
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#decorators" title="Decorators" class="md-nav__link">
    Decorators
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/seesharper/lightinject/edit/master/docs/webapirequestlogging.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="web-api-request-logging">Web Api Request Logging</h1>
<p>This post is going to show you how to use <strong>LightInject</strong> to enable logging in a <strong>Web Api</strong> application. We are going to look into how to preserve contextual information associated with the incoming request so that this information can be used for logging purposes. All this goodness is going to end up in a simple <a href="https://github.com/seesharper/Blog.WebApiRequestLogging">console application</a> that shows how all the pieces fit together.</p>
<h2 id="logging">Logging</h2>
<p>Since logging is a cross cutting concern and is to be found scattered all around in our application, it makes sense to create an abstraction so that we don't create a direct dependency on a particular logging framework. This abstraction is something that we should own rather than relying on third part abstraction such as <a href="https://github.com/net-commons/common-logging">Common Logging</a>. Believe me, that is going to cause us nothing but pain as we would have to deal with different versions of a third party abstraction. Own you own abstraction!</p>
<p>We start of with a simple interface that is going to be used for logging.</p>
<pre><code>public interface ILog
{      
    void Info(string message);

    void Debug(string message);

    void Error(string message, Exception exception = null);
}
</code></pre>

<p>This is the interface that we will be injection into controllers, services or any other class that requires logging.</p>
<p>The actual implementation of this interface looks like this</p>
<pre><code>public class Log : ILog
{
    private readonly Action&lt;string&gt; logDebug;
    private readonly Action&lt;string, Exception&gt; logError;
    private readonly Action&lt;string&gt; logInfo;

    public Log(Action&lt;string&gt; logInfo, Action&lt;string&gt; logDebug, Action&lt;string, Exception&gt; logError)
    {
        this.logInfo = logInfo;
        this.logDebug = logDebug;
        this.logError = logError;
    }

    public void Info(string message)
    {
        logInfo(message);
    }

    public void Debug(string message)
    {
        logDebug(message);
    }

    public void Error(string message, Exception exception = null)
    {
        logError(message, exception);
    }
}
</code></pre>

<p>The <strong>Log</strong> class is not tied to a specific logging framework and it just takes a set of action delegates that represents the three logging levels supported by our abstraction.</p>
<p>To help us create a <strong>Log</strong> instance, we have this nice little interface.</p>
<pre><code>public interface ILogFactory
{
    ILog GetLogger(Type type);
}
</code></pre>

<p>And since we are going to be using <strong>Log4Net</strong> in this sample application, we have an implementation called <strong>Log4NetLogFactory</strong>.</p>
<pre><code>public class Log4NetLogFactory : ILogFactory
{
    public Log4NetLogFactory()
    {
        XmlConfigurator.Configure();           
    }

    public ILog GetLogger(Type type)
    {            
        var logger = LogManager.GetLogger(type);            
        return new Log(logger.Info, logger.Debug, logger.Error);
    }
}
</code></pre>

<blockquote>
<p>Note: This is the ONLY place where we actually reference Log4Net.</p>
</blockquote>
<h2 id="composition-root">Composition root</h2>
<p>This application has two composition roots (<strong>ICompositionRoot</strong>), one that registers the core services (<strong>CompositionRoot</strong> )and one that registers services related to <strong>Web Api</strong> (<strong>WebApiCompositionRoot</strong>). </p>
<pre><code>public class CompositionRoot : ICompositionRoot
{
    public void Compose(IServiceRegistry serviceRegistry)
    {            
        serviceRegistry.Register&lt;ILogFactory, Log4NetLogFactory&gt;(new PerContainerLifetime());
        serviceRegistry.Register&lt;Type, ILog&gt;((factory, type) =&gt; factory.GetInstance&lt;ILogFactory&gt;().GetLogger(type));
        serviceRegistry.RegisterConstructorDependency(
            (factory, info) =&gt; factory.GetInstance&lt;Type, ILog&gt;(info.Member.DeclaringType));            
    }
}
</code></pre>

<p>The first service that we register is the <strong>ILogFactory</strong> that is responsible for creating an <strong>ILog</strong> instance based on a given type.</p>
<p>Next, we register the <strong>ILog</strong> service with a factory delegate that calls into the already registered <strong>ILogFactory</strong> service</p>
<p>Finally we tell the container using the <strong>RegisterConstructorDependency</strong> method that whenever it sees an <strong>ILog</strong> constructor dependency, it should provide an <strong>ILog</strong> instance based on the actual class that uses it. </p>
<pre><code>public class WebApiCompositionRoot : ICompositionRoot
{
    public void Compose(IServiceRegistry serviceRegistry)
    {
        serviceRegistry.RegisterFrom&lt;CompositionRoot&gt;();
        serviceRegistry.RegisterApiControllers();
    }
}
</code></pre>

<p>The <strong>WebApiCompositionRoot</strong> registers core services in addition services related to <strong>Web Api</strong> which in this case means the controllers. </p>
<h2 id="controllers">Controllers</h2>
<p>This application has just one controller named <strong>PingController</strong> that is simply going to return the text "pong".</p>
<pre><code>public class PingController : ApiController
{
    private readonly ILog log;

    public PingController(ILog log)
    {
        this.log = log;
    }

    public async Task&lt;IHttpActionResult&gt; Get()
    {
        log.Info(&quot;Ping start&quot;);        
        var result =  Ok(&quot;Pong&quot;);
        log.Info(&quot;Ping end&quot;);
        return result;
    }
}
</code></pre>

<p>As we can see we are injecting an <strong>ILog</strong> instance into the controller.</p>
<p>The <strong>Startup</strong> class for this application looks like this</p>
<pre><code>public class Startup
{
    public void Configuration(IAppBuilder app)
    {
        var configuration = new HttpConfiguration();
        ConfigureHttpRoutes(configuration);
        ConfigureMediaFormatter(configuration);

        var container = new ServiceContainer();
        container.RegisterFrom&lt;WebApiCompositionRoot&gt;();            
        container.EnableWebApi(configuration);           

        app.UseWebApi(configuration);
    }

    private static void ConfigureMediaFormatter(HttpConfiguration configuration)
    {
        configuration.Formatters.Clear();
        configuration.Formatters.Add(new JsonMediaTypeFormatter());
    }

    private static void ConfigureHttpRoutes(HttpConfiguration config)
    {
        config.Routes.MapHttpRoute(
            name: &quot;API Default&quot;,
            routeTemplate: &quot;api/{controller}/{id}&quot;,
            defaults: new { id = RouteParameter.Optional });
    }
}
</code></pre>

<p>We can see all this in action just by running the application and hitting the service.</p>
<pre><code>http://localhost:8080/api/ping
</code></pre>

<p>That should yield the following output in the console</p>
<pre><code>2016-02-11 09:14:28.489 [INFO] 13 WebApiRequestLogging.PingController: Ping start
2016-02-11 09:14:28.603 [INFO] 6 WebApiRequestLogging.PingController: Ping end
</code></pre>

<p>The <strong>Log4Net</strong> conversion pattern is like this (app.config)</p>
<pre><code>&lt;conversionPattern value=&quot;%date{yyyy-MM-dd HH:mm:ss.fff} [%level] %thread %logger: %message%newline&quot; /&gt;
</code></pre>

<h2 id="request-logging">Request logging</h2>
<p>Sometimes it might be useful to log each request and maybe also the duration of the request.
We start off with a simple class (<strong>OwinMiddleware</strong>) that logs the duration of the request.</p>
<pre><code>public class RequestLoggingMiddleware : OwinMiddleware
{
    private readonly ILog log;


    public RequestLoggingMiddleware(OwinMiddleware next, ILog log) : base(next)
    {
        this.log = log;
    }

    public override async Task Invoke(IOwinContext context)
    {            
        await Measure(context).ConfigureAwait(false);;            
    }

    private async Task Measure(IOwinContext context)
    {
        var stopWath = Stopwatch.StartNew();
        await Next.Invoke(context).ConfigureAwait(false);
        stopWath.Stop();
        log.Info($&quot;Request {context.Request.Uri.PathAndQuery} took {stopWath.ElapsedMilliseconds} ms&quot;);
    }
}
</code></pre>

<p>In addition to this we need to add this new middleware to the <strong>Owin</strong> pipeline by adding this line to the <strong>Startup</strong> class.</p>
<pre><code>app.Use&lt;RequestLoggingMiddleware&gt;(container.GetInstance&lt;Type, ILog&gt;(typeof (RequestLogDecorator)));
</code></pre>

<blockquote>
<p>Note: The reason for using an <strong>OwinMiddleware</strong> instead of a <strong>DelegatingHandler</strong> is that the <strong>OwinMiddleware</strong> is not tied to <strong>Web Api</strong> in any way and can also be used in other frameworks that build upon the <strong>Owin</strong> stack.</p>
</blockquote>
<p>Console output should now be</p>
<pre><code>2016-02-11 13:07:48.466 [INFO] 11 WebApiRequestLogging.RequestLoggingMiddleware: Request /api/ping took 4 ms
</code></pre>

<h2 id="request-context">Request Context</h2>
<p>In some situations it is useful to be able to associate all log entries with the current web request. This can be used for analyzing the log later in tools such as <strong>Splunk</strong> making it possible to see all log entries tied to any given request.</p>
<p>We could make the <strong>IOwinContext</strong> available in the container so that it could be injected into any class that requires information about the current request. This would however mean that these classes would have to know about the <strong>IOwinContext</strong> which might not be the best solution. </p>
<p>So let's start off simple by creating a class to hold the request identifier.</p>
<pre><code>public class RequestContext
{
    public RequestContext(string id)
    {
        Id = id;
    }

    public string Id { get; } 
}
</code></pre>

<p>Next we create another middleware class to set the request identifier.</p>
<pre><code>public class RequestContextMiddleware : OwinMiddleware
{
    private static readonly AsyncLocal&lt;RequestContext&gt; RequestContextStorage = new AsyncLocal&lt;RequestContext&gt;();

    public RequestContextMiddleware(OwinMiddleware next) : base(next)
    {
    }

    public override async Task Invoke(IOwinContext context)
    {
        RequestContextStorage.Value = new RequestContext(Guid.NewGuid().ToString());
        await Next.Invoke(context);
    }

    public static RequestContext CurrentRequest =&gt; RequestContextStorage.Value;
}
</code></pre>

<p>The actual <strong>RequestContext</strong> uses the <strong>AsyncLocal&lt;T&gt;</strong> class to ensure that the context flows across await points.</p>
<blockquote>
<p>The <strong>AsyncLocal&lt;T&gt;</strong> class is sort of the async version of <strong>ThreadLocal&lt;T&gt;</strong>. You should NEVER rely on any kind of storage that is tied to a specific thread in an async environment.</p>
</blockquote>
<p>Then we need to add the  <strong>RequestContextMiddleware</strong> to the <strong>Owin</strong> pipeline.</p>
<pre><code> app.Use&lt;RequestContextMiddleware&gt;();
</code></pre>

<p>We now have way to access the current <strong>RequestContext</strong> through the <strong>CurrentRequest</strong> property. Sweet.</p>
<p>The only thing missing now is to register a function delegate that represent getting the current <strong>RequestContext</strong>.</p>
<pre><code>serviceRegistry.Register&lt;Func&lt;RequestContext&gt;&gt;(factory =&gt; (() =&gt; RequestContextMiddleware.CurrentRequest), new PerContainerLifetime());
</code></pre>

<p>The reason for injection a function delegate rather than just the <strong>RequestContext</strong> is that it might be used in services such as singletons that outlives the scope of a web request. By injecting the delegate that in turn gives us the <strong>RequestContext</strong>, we can be sure that it is valid.</p>
<h2 id="decorators">Decorators</h2>
<p>The requirement here is that if we are logging outside the context of a web request, such as in a unit test, we should just log without the request identifier, but if we log inside a web request (production or integration tests), we should add the request identifier to the message being logged. This is a perfect example of where we can apply the <strong>Decorator Pattern</strong>. This allows us to add new functionality to a service without touching the original implementation. Did I hear "open-closed principle", anyone?</p>
<pre><code>public class RequestLogDecorator : ILog
{
    private readonly ILog log;
    private readonly Func&lt;RequestContext&gt; getRequestContext;

    public RequestLogDecorator(ILog log, Func&lt;RequestContext&gt; getRequestContext)
    {
        this.log = log;
        this.getRequestInfo = getRequestInfo;
    }

    public void Info(string message)
    {
        log.Info($&quot;Request id: {getRequestContext().Id} {message}&quot;);
    }

    public void Debug(string message)
    {
        log.Debug($&quot;Request id: {getRequestContext().Id} {message}&quot;);
    }

    public void Error(string message, Exception exception = null)
    {
        log.Error($&quot;Request id: {getRequestContext().Id} {message}&quot;, exception);
    }
}
</code></pre>

<p>The decorator simply wraps the original <strong>ILog</strong> instance and applies the request identifier now returned from the <strong>getRequestContext</strong> delegate.  Don't you just love the new string interpolation features? </p>
<blockquote>
<p>Note: If you are new to the decorator pattern, you can think of it as a <a href="https://en.wikipedia.org/wiki/Matryoshka_doll">Russian Doll</a> where inside there is an exact identical doll wrapped by an outer doll.</p>
</blockquote>
<p>Decorators are first-class citizens in <strong>LightInject</strong> and applying a decorator is just a one-liner in the <strong>WepApiCompositionRoot</strong> class.</p>
<pre><code>serviceRegistry.Decorate&lt;ILog, RequestLogDecorator&gt;();
</code></pre>

<p>Since we only apply the decorator in the <strong>WepApiCompositionRoot</strong> class it will only be used in the context of a web request.</p>
<p>To "ensure" that we don't always log on the same thread, we modify the <strong>PingController</strong> to inlude a delay.</p>
<pre><code>public async Task&lt;IHttpActionResult&gt; Get()
{
    log.Info(&quot;Ping start&quot;);

    //ConfigureAwait(false) to say that we don't care about synchronization context.
    await Task.Delay(100).ConfigureAwait(false);

    // We are probably on another thread here
    var result =  Ok(&quot;Pong&quot;);
    log.Info(&quot;Ping end&quot;);
    return result;
}
</code></pre>

<p>Running the application and hitting the service should now yield the following output in the console</p>
<pre><code>2016-02-11 20:40:30.994 [INFO] 12 WebApiRequestLogging.PingController: Request id: 91444099-72ad-488f-99d6-ab201f20531e Ping start
2016-02-11 20:40:31.111 [INFO] 6 WebApiRequestLogging.PingController: Request id: 91444099-72ad-488f-99d6-ab201f20531e Ping end
2016-02-11 20:40:31.205 [INFO] 6 WebApiRequestLogging.RequestLogDecorator: Request id: 91444099-72ad-488f-99d6-ab201f20531e Request /api/ping took 463 ms
</code></pre>

<p>As we can see that even if we started and ended the request on two different threads, we still have the same request identifier.</p>
<p>Happy logging!!</p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../microsoft.dependencyinjection/" title="Microsoft DI" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Microsoft DI
              </span>
            </div>
          </a>
        
        
          <a href="../transactions/" title="Transactions and Testing" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Transactions and Testing
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.9e1f3b71.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
    
    
      
    
  </body>
</html>